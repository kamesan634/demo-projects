# 即時聊天室系統 - 系統分析文件

**文件版本**: v1.0
**建立日期**: 2026-01-09
**專案名稱**: Real-time Chat System (龜三的Go WebSocket Demo)

---

## 目錄

1. [系統概述](#1-系統概述)
2. [專案範圍與目標](#2-專案範圍與目標)
3. [使用者故事與功能需求](#3-使用者故事與功能需求)
4. [使用者角色與權限](#4-使用者角色與權限)
5. [功能模組清單](#5-功能模組清單)
6. [系統架構](#6-系統架構)
7. [資料庫設計](#7-資料庫設計)
8. [API設計](#8-api設計)
9. [WebSocket 協議設計](#9-websocket-協議設計)
10. [非功能性需求](#10-非功能性需求)
11. [名詞定義](#11-名詞定義)

---

## 1. 系統概述

### 1.1 專案背景

本系統為一套即時聊天室應用程式，旨在展示 Go 語言在高併發場景下的卓越效能，以及 WebSocket 實現即時通訊的技術能力。系統採用 Goroutine 與 Channel 實現高效的併發處理，支援大量用戶同時在線聊天。

### 1.2 系統定位

| 項目 | 說明 |
|------|------|
| **目標用戶** | 需要即時通訊功能的應用場景 |
| **系統類型** | Web-based 即時通訊應用程式 |
| **部署方式** | 雲端部署 / 容器化部署 (Docker/K8s) |
| **展示用途** | Go 語言高併發處理能力與 WebSocket 技術展示 |

### 1.3 技術亮點

| 技術特點 | 說明 |
|---------|------|
| **Goroutine 併發模型** | 每個 WebSocket 連線使用獨立的 Goroutine 處理 |
| **Channel 訊息傳遞** | 使用 Channel 實現安全的訊息廣播機制 |
| **連線池管理** | Hub 模式集中管理所有活躍連線 |
| **心跳檢測** | Ping/Pong 機制維持連線狀態 |
| **訊息佇列** | 支援訊息緩衝與批次處理 |
| **水平擴展** | 支援 Redis Pub/Sub 跨節點訊息同步 |

### 1.4 技術架構概述

```
┌─────────────────────────────────────────────────────────────┐
│                      前端 (Frontend)                         │
│              React / Vue.js + WebSocket Client              │
├─────────────────────────────────────────────────────────────┤
│                     WebSocket 層                             │
│                 Gorilla WebSocket / nhooyr                   │
├─────────────────────────────────────────────────────────────┤
│                      後端 (Backend)                          │
│                    Go (Gin/Echo/Fiber)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Hub 管理    │  │ Goroutine   │  │  Channel    │         │
│  │ (連線池)     │  │  Pool       │  │  Message    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      快取層 (Cache)                          │
│                        Redis                                 │
│           (Session / Pub-Sub / Message Queue)               │
├─────────────────────────────────────────────────────────────┤
│                    資料層 (Database)                         │
│                  PostgreSQL / MySQL                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 專案範圍與目標

### 2.1 專案目標

| 目標類型 | 描述 |
|---------|------|
| **主要目標** | 建立一套高效能、高併發的即時聊天系統 |
| **業務目標** | 展示即時通訊解決方案的完整實現 |
| **技術目標** | 展示 Go 語言併發處理能力與 WebSocket 技術整合 |

### 2.2 專案範圍

#### 包含範圍 (In Scope)

- 使用者註冊與登入
- 公開聊天室 (大廳)
- 私人聊天室建立與管理
- 一對一私訊功能
- 即時訊息推送
- 歷史訊息查詢
- 線上狀態顯示
- 訊息已讀功能
- 檔案/圖片傳送 (基礎)
- 系統通知推送

#### 排除範圍 (Out of Scope)

- 語音/視訊通話
- 端對端加密 (E2E Encryption)
- 訊息搜尋進階功能
- 機器人 (Bot) 整合
- 多語系國際化
- 付費功能模組

### 2.3 假設與限制

**假設條件**:
- 用戶使用現代瀏覽器 (支援 WebSocket)
- 網路環境相對穩定
- 單一伺服器可支援 10,000+ 併發連線
- 使用 UTF-8 編碼傳輸訊息

**限制條件**:
- 展示系統，非正式生產環境
- 單檔案上傳限制 10MB
- 訊息長度限制 4,000 字元
- 聊天室成員上限 500 人

---

## 3. 使用者故事與功能需求

### 3.1 使用者故事

#### 註冊與登入

| 編號 | 使用者故事 | 優先順序 |
|------|-----------|:-------:|
| US-001 | 作為訪客，我想要註冊帳號，以便開始使用聊天功能 | P0 |
| US-002 | 作為用戶，我想要登入系統，以便進入聊天室 | P0 |
| US-003 | 作為用戶，我想要登出系統，以保護我的帳號安全 | P0 |
| US-004 | 作為用戶，我想要修改個人資料，以更新我的顯示名稱和頭像 | P1 |
| US-005 | 作為用戶，我想要重設密碼，以便在忘記密碼時恢復帳號 | P1 |

#### 聊天室功能

| 編號 | 使用者故事 | 優先順序 |
|------|-----------|:-------:|
| US-101 | 作為用戶，我想要進入公開大廳，以便與所有線上用戶聊天 | P0 |
| US-102 | 作為用戶，我想要建立私人聊天室，以便邀請特定好友聊天 | P0 |
| US-103 | 作為用戶，我想要加入現有聊天室，以參與群組對話 | P0 |
| US-104 | 作為用戶，我想要離開聊天室，以停止接收該聊天室訊息 | P1 |
| US-105 | 作為聊天室擁有者，我想要管理成員，以控制誰能參與聊天 | P1 |
| US-106 | 作為聊天室擁有者，我想要設定聊天室名稱和描述 | P2 |

#### 訊息功能

| 編號 | 使用者故事 | 優先順序 |
|------|-----------|:-------:|
| US-201 | 作為用戶，我想要發送文字訊息，以與他人溝通 | P0 |
| US-202 | 作為用戶，我想要即時收到新訊息，以進行流暢對話 | P0 |
| US-203 | 作為用戶，我想要查看歷史訊息，以回顧之前的對話 | P0 |
| US-204 | 作為用戶，我想要發送圖片/檔案，以分享多媒體內容 | P1 |
| US-205 | 作為用戶，我想要看到訊息已讀狀態，以知道對方是否看過 | P1 |
| US-206 | 作為用戶，我想要收到@提及通知，以便知道有人叫我 | P2 |
| US-207 | 作為用戶，我想要使用表情符號回應訊息 | P2 |

#### 私訊功能

| 編號 | 使用者故事 | 優先順序 |
|------|-----------|:-------:|
| US-301 | 作為用戶，我想要發送私訊給特定用戶 | P0 |
| US-302 | 作為用戶，我想要查看私訊對話列表 | P0 |
| US-303 | 作為用戶，我想要封鎖特定用戶，以不再收到其訊息 | P1 |

#### 線上狀態

| 編號 | 使用者故事 | 優先順序 |
|------|-----------|:-------:|
| US-401 | 作為用戶，我想要看到誰在線上，以知道可以找誰聊天 | P0 |
| US-402 | 作為用戶，我想要設定我的線上狀態 (在線/離開/勿擾) | P1 |
| US-403 | 作為用戶，我想要收到好友上線通知 | P2 |

### 3.2 驗收標準範例

**US-201: 發送文字訊息**

```gherkin
Feature: 發送文字訊息

  Scenario: 成功發送訊息到聊天室
    Given 我已登入系統
    And 我已加入聊天室 "技術討論區"
    When 我在輸入框輸入 "大家好！"
    And 我點擊發送按鈕
    Then 訊息應該出現在聊天視窗
    And 其他聊天室成員應該即時收到訊息
    And 訊息應顯示我的名稱和發送時間

  Scenario: 訊息長度超過限制
    Given 我已登入系統
    And 我已加入聊天室
    When 我輸入超過 4000 字元的訊息
    And 我點擊發送按鈕
    Then 系統應顯示錯誤訊息 "訊息長度不可超過 4000 字元"
    And 訊息不應被發送
```

---

## 4. 使用者角色與權限

### 4.1 角色定義

| 角色代碼 | 角色名稱 | 說明 |
|---------|---------|------|
| ADMIN | 系統管理員 | 擁有所有功能權限，管理系統設定與用戶 |
| MOD | 聊天室管理員 | 管理特定聊天室，可禁言/踢除成員 |
| USER | 一般用戶 | 使用聊天功能的標準用戶 |
| GUEST | 訪客 | 僅能查看公開聊天室，不能發言 |

### 4.2 權限矩陣

| 功能 | ADMIN | MOD | USER | GUEST |
|------|:-----:|:---:|:----:|:-----:|
| 查看公開聊天室 | ✓ | ✓ | ✓ | ✓ |
| 發送訊息 | ✓ | ✓ | ✓ | - |
| 建立聊天室 | ✓ | ✓ | ✓ | - |
| 發送私訊 | ✓ | ✓ | ✓ | - |
| 上傳檔案 | ✓ | ✓ | ✓ | - |
| 禁言成員 | ✓ | ✓ | - | - |
| 踢除成員 | ✓ | ✓ | - | - |
| 刪除訊息 | ✓ | ✓ | R | - |
| 管理聊天室設定 | ✓ | ✓ | R | - |
| 封鎖/解封用戶 | ✓ | - | - | - |
| 系統設定 | ✓ | - | - | - |
| 查看系統統計 | ✓ | - | - | - |

> ✓ = 完整權限, R = 僅限自己的資源, - = 無權限

### 4.3 聊天室角色

| 角色 | 說明 | 權限 |
|------|------|------|
| OWNER | 聊天室建立者 | 完整管理權限，可轉移擁有權 |
| ADMIN | 聊天室管理員 | 管理成員、訊息，不可刪除聊天室 |
| MEMBER | 一般成員 | 發送訊息、查看歷史 |

---

## 5. 功能模組清單

### 5.1 模組總覽

| 模組代碼 | 模組名稱 | 功能數量 | 優先順序 |
|---------|---------|:-------:|:-------:|
| M01 | 用戶管理模組 | 6 | P0 |
| M02 | 認證授權模組 | 4 | P0 |
| M03 | 聊天室管理模組 | 8 | P0 |
| M04 | 訊息處理模組 | 7 | P0 |
| M05 | 私訊模組 | 4 | P0 |
| M06 | 線上狀態模組 | 3 | P1 |
| M07 | 通知推送模組 | 3 | P1 |
| M08 | 檔案管理模組 | 3 | P1 |
| M09 | 系統管理模組 | 5 | P2 |

### 5.2 模組功能明細

#### M01 用戶管理模組

| 功能代碼 | 功能名稱 | 說明 |
|---------|---------|------|
| F01-001 | 用戶註冊 | 新用戶建立帳號 |
| F01-002 | 用戶登入 | 驗證並取得 Token |
| F01-003 | 用戶登出 | 清除 Session/Token |
| F01-004 | 個人資料編輯 | 修改顯示名稱、頭像等 |
| F01-005 | 密碼變更 | 修改登入密碼 |
| F01-006 | 帳號停用/啟用 | 管理員控制帳號狀態 |

#### M03 聊天室管理模組

| 功能代碼 | 功能名稱 | 說明 |
|---------|---------|------|
| F03-001 | 建立聊天室 | 建立公開/私人聊天室 |
| F03-002 | 加入聊天室 | 用戶加入現有聊天室 |
| F03-003 | 離開聊天室 | 用戶退出聊天室 |
| F03-004 | 聊天室列表 | 查詢可加入的聊天室 |
| F03-005 | 聊天室設定 | 編輯名稱、描述、類型 |
| F03-006 | 成員管理 | 邀請/移除/禁言成員 |
| F03-007 | 刪除聊天室 | 擁有者刪除聊天室 |
| F03-008 | 聊天室成員列表 | 查看聊天室所有成員 |

#### M04 訊息處理模組

| 功能代碼 | 功能名稱 | 說明 |
|---------|---------|------|
| F04-001 | 發送訊息 | WebSocket 即時發送 |
| F04-002 | 接收訊息 | WebSocket 即時接收 |
| F04-003 | 訊息廣播 | Hub 廣播至聊天室成員 |
| F04-004 | 歷史訊息 | 分頁查詢歷史訊息 |
| F04-005 | 訊息已讀 | 標記訊息已讀狀態 |
| F04-006 | 刪除訊息 | 刪除自己的訊息 |
| F04-007 | 訊息搜尋 | 關鍵字搜尋訊息 |

### 5.3 模組關聯圖

```
                    ┌─────────────────┐
                    │   認證授權模組   │
                    │   (JWT Token)   │
                    └────────┬────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                        用戶管理模組                              │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│   │ 註冊登入  │  │ 個人資料  │  │ 好友關係  │  │ 封鎖列表  │       │
│   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
└────────┼─────────────┼─────────────┼─────────────┼──────────────┘
         │             │             │             │
    ┌────┴────┐   ┌────┴────┐   ┌────┴────┐   ┌────┴────┐
    ▼         ▼   ▼         ▼   ▼         ▼   ▼         ▼
┌───────────────────────────────────────────────────────────────┐
│                      WebSocket 連線層                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │    Hub      │  │   Client    │  │   Room      │           │
│  │  (連線池)    │◄─│  Goroutine  │──│  Channel    │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
└───────────────────────────────────────────────────────────────┘
         │             │             │             │
         ▼             ▼             ▼             ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│聊天室模組 │ │ 訊息模組   │ │ 私訊模組   │ │ 通知模組   │
└───────────┘ └───────────┘ └───────────┘ └───────────┘
         │             │             │             │
         └─────────────┴──────┬──────┴─────────────┘
                              ▼
                     ┌─────────────────┐
                     │    資料儲存     │
                     │ (PostgreSQL +   │
                     │     Redis)      │
                     └─────────────────┘
```

---

## 6. 系統架構

### 6.1 高併發架構設計

```
                         ┌──────────────────┐
                         │   Load Balancer  │
                         │    (Nginx)       │
                         └────────┬─────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              │                   │                   │
              ▼                   ▼                   ▼
    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
    │   Go Server 1   │ │   Go Server 2   │ │   Go Server N   │
    │  ┌───────────┐  │ │  ┌───────────┐  │ │  ┌───────────┐  │
    │  │    Hub    │  │ │  │    Hub    │  │ │  │    Hub    │  │
    │  │ (Local)   │  │ │  │ (Local)   │  │ │  │ (Local)   │  │
    │  └─────┬─────┘  │ │  └─────┬─────┘  │ │  └─────┬─────┘  │
    │        │        │ │        │        │ │        │        │
    │  ┌─────┴─────┐  │ │  ┌─────┴─────┐  │ │  ┌─────┴─────┐  │
    │  │ Clients   │  │ │  │ Clients   │  │ │  │ Clients   │  │
    │  │ (10000+)  │  │ │  │ (10000+)  │  │ │  │ (10000+)  │  │
    │  └───────────┘  │ │  └───────────┘  │ │  └───────────┘  │
    └────────┬────────┘ └────────┬────────┘ └────────┬────────┘
             │                   │                   │
             └───────────────────┼───────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │     Redis Cluster      │
                    │  ┌──────────────────┐  │
                    │  │   Pub/Sub        │  │  ◄── 跨節點訊息同步
                    │  │   Session Store  │  │
                    │  │   Online Status  │  │
                    │  └──────────────────┘  │
                    └───────────┬────────────┘
                                │
                                ▼
                    ┌────────────────────────┐
                    │     PostgreSQL         │
                    │   (Primary-Replica)    │
                    └────────────────────────┘
```

### 6.2 WebSocket Hub 設計 (Go 實作概念)

```go
// Hub 維護活躍的客戶端連線集合
type Hub struct {
    // 已註冊的客戶端
    clients map[*Client]bool

    // 聊天室映射: roomID -> clients
    rooms map[string]map[*Client]bool

    // 從客戶端接收的訊息
    broadcast chan *Message

    // 註冊請求
    register chan *Client

    // 取消註冊請求
    unregister chan *Client

    // 加入聊天室請求
    joinRoom chan *RoomRequest

    // 離開聊天室請求
    leaveRoom chan *RoomRequest
}

// Client 代表單一 WebSocket 連線
type Client struct {
    hub      *Hub
    conn     *websocket.Conn
    userID   string
    username string
    rooms    map[string]bool  // 已加入的聊天室
    send     chan []byte      // 發送緩衝區
}
```

### 6.3 Goroutine 處理流程

```
                        ┌──────────────────┐
                        │   New WebSocket  │
                        │    Connection    │
                        └────────┬─────────┘
                                 │
                                 ▼
                        ┌──────────────────┐
                        │  Create Client   │
                        │   Goroutine      │
                        └────────┬─────────┘
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
                ▼                ▼                ▼
        ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
        │ readPump()   │ │ writePump()  │ │  Hub.run()   │
        │ Goroutine    │ │ Goroutine    │ │  Goroutine   │
        │              │ │              │ │              │
        │ - 讀取訊息   │ │ - 發送訊息   │ │ - 管理連線   │
        │ - 心跳檢測   │ │ - 心跳回應   │ │ - 廣播訊息   │
        │ - JSON 解析  │ │ - 緩衝處理   │ │ - 路由處理   │
        └──────────────┘ └──────────────┘ └──────────────┘
                │                ▲                │
                │                │                │
                ▼                │                ▼
        ┌──────────────┐        │        ┌──────────────┐
        │   Message    │        │        │   Clients    │
        │   Channel    │────────┴───────>│     Map      │
        └──────────────┘                 └──────────────┘
```

---

## 7. 資料庫設計

### 7.1 ER Diagram

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    users    │     │   rooms     │     │   members   │
│─────────────│     │─────────────│     │─────────────│
│ id (PK)     │     │ id (PK)     │     │ id (PK)     │
│ username    │◄───>│ owner_id(FK)│     │ room_id(FK) │◄──┐
│ email       │     │ name        │     │ user_id(FK) │───┼─┐
│ password    │     │ type        │     │ role        │   │ │
│ avatar_url  │     │ is_private  │     │ joined_at   │   │ │
│ status      │     │ created_at  │     │ muted_until │   │ │
│ created_at  │     └─────────────┘     └─────────────┘   │ │
└─────────────┘            │                   │          │ │
      │                    │                   │          │ │
      │                    ▼                   │          │ │
      │            ┌─────────────┐             │          │ │
      │            │  messages   │             │          │ │
      │            │─────────────│             │          │ │
      │            │ id (PK)     │             │          │ │
      └───────────>│ sender_id   │◄────────────┘          │ │
                   │ room_id(FK) │◄────────────────────────┘ │
                   │ content     │                           │
                   │ type        │                           │
                   │ created_at  │                           │
                   └─────────────┘                           │
                          │                                  │
                          ▼                                  │
                   ┌─────────────┐     ┌─────────────┐      │
                   │ read_status │     │direct_msgs  │      │
                   │─────────────│     │─────────────│      │
                   │ message_id  │     │ id (PK)     │      │
                   │ user_id(FK) │     │ sender_id   │◄─────┘
                   │ read_at     │     │ receiver_id │
                   └─────────────┘     │ content     │
                                       │ read_at     │
                                       │ created_at  │
                                       └─────────────┘
```

### 7.2 資料表定義

#### users (用戶)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    display_name NVARCHAR(100),
    avatar_url VARCHAR(500),
    status ENUM('online', 'away', 'busy', 'offline') DEFAULT 'offline',
    role ENUM('admin', 'moderator', 'user', 'guest') DEFAULT 'user',
    is_active BOOLEAN DEFAULT TRUE,
    last_seen_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status)
);
```

#### rooms (聊天室)

```sql
CREATE TABLE rooms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name NVARCHAR(100) NOT NULL,
    description NVARCHAR(500),
    owner_id UUID NOT NULL,
    type ENUM('public', 'private', 'direct') NOT NULL DEFAULT 'public',
    is_active BOOLEAN DEFAULT TRUE,
    max_members INT DEFAULT 500,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (owner_id) REFERENCES users(id),
    INDEX idx_type (type),
    INDEX idx_owner (owner_id)
);
```

#### room_members (聊天室成員)

```sql
CREATE TABLE room_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID NOT NULL,
    user_id UUID NOT NULL,
    role ENUM('owner', 'admin', 'member') DEFAULT 'member',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    muted_until TIMESTAMP,
    is_banned BOOLEAN DEFAULT FALSE,

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_room_user (room_id, user_id),
    INDEX idx_user (user_id)
);
```

#### messages (訊息)

```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID NOT NULL,
    sender_id UUID NOT NULL,
    content TEXT NOT NULL,
    message_type ENUM('text', 'image', 'file', 'system') DEFAULT 'text',
    file_url VARCHAR(500),
    file_name VARCHAR(255),
    file_size INT,
    reply_to_id UUID,
    is_edited BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(id),
    FOREIGN KEY (reply_to_id) REFERENCES messages(id),
    INDEX idx_room_created (room_id, created_at DESC),
    INDEX idx_sender (sender_id)
);
```

#### message_read_status (訊息已讀狀態)

```sql
CREATE TABLE message_read_status (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL,
    user_id UUID NOT NULL,
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_message_user (message_id, user_id),
    INDEX idx_user_read (user_id, read_at)
);
```

#### direct_messages (私訊)

```sql
CREATE TABLE direct_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sender_id UUID NOT NULL,
    receiver_id UUID NOT NULL,
    content TEXT NOT NULL,
    message_type ENUM('text', 'image', 'file') DEFAULT 'text',
    file_url VARCHAR(500),
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,
    is_deleted_by_sender BOOLEAN DEFAULT FALSE,
    is_deleted_by_receiver BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (sender_id) REFERENCES users(id),
    FOREIGN KEY (receiver_id) REFERENCES users(id),
    INDEX idx_conversation (sender_id, receiver_id, created_at DESC),
    INDEX idx_receiver_unread (receiver_id, is_read)
);
```

#### user_blocks (用戶封鎖)

```sql
CREATE TABLE user_blocks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    blocker_id UUID NOT NULL,
    blocked_id UUID NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (blocker_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (blocked_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_block (blocker_id, blocked_id)
);
```

### 7.3 Redis 資料結構

| Key Pattern | Type | 說明 | TTL |
|-------------|------|------|-----|
| `user:session:{token}` | String | 用戶 Session 資訊 | 24h |
| `user:online` | Set | 在線用戶 ID 集合 | - |
| `user:status:{userID}` | String | 用戶狀態 (online/away/busy) | - |
| `room:members:{roomID}` | Set | 聊天室成員 ID 集合 | - |
| `room:online:{roomID}` | Set | 聊天室在線成員 | - |
| `user:rooms:{userID}` | Set | 用戶已加入的聊天室 | - |
| `msg:unread:{userID}:{roomID}` | String | 未讀訊息數量 | - |
| `typing:{roomID}` | Hash | 正在輸入的用戶 | 5s |

---

## 8. API設計

### 8.1 設計原則

| 項目 | 規範 |
|------|------|
| 風格 | RESTful API + WebSocket |
| 格式 | JSON |
| 認證 | JWT Bearer Token |
| 版本 | URL 路徑版本控制 (v1) |
| 命名 | 小寫、複數名詞、kebab-case |

### 8.2 通用回應格式

**成功回應**:
```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "page": 1,
    "per_page": 50,
    "total": 1000,
    "has_more": true
  }
}
```

**錯誤回應**:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "輸入驗證失敗",
    "details": [
      { "field": "username", "message": "使用者名稱已被使用" }
    ]
  }
}
```

### 8.3 認證 API

#### 用戶註冊

```
POST /api/v1/auth/register
```

**Request Body**:
```json
{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "SecurePass123!",
  "display_name": "John Doe"
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "john_doe",
      "email": "john@example.com",
      "display_name": "John Doe",
      "created_at": "2026-01-09T10:30:00Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 用戶登入

```
POST /api/v1/auth/login
```

**Request Body**:
```json
{
  "email": "john@example.com",
  "password": "SecurePass123!"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "john_doe",
      "display_name": "John Doe",
      "avatar_url": "https://cdn.example.com/avatars/john.jpg",
      "status": "online"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_at": "2026-01-10T10:30:00Z"
  }
}
```

#### 更新 Token

```
POST /api/v1/auth/refresh
Authorization: Bearer {refresh_token}
```

### 8.4 用戶 API

#### 取得用戶資料

```
GET /api/v1/users/:id
Authorization: Bearer {token}
```

**Response**:
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "john_doe",
    "display_name": "John Doe",
    "avatar_url": "https://cdn.example.com/avatars/john.jpg",
    "status": "online",
    "last_seen_at": "2026-01-09T10:30:00Z"
  }
}
```

#### 更新用戶資料

```
PUT /api/v1/users/me
Authorization: Bearer {token}
```

**Request Body**:
```json
{
  "display_name": "Johnny",
  "avatar_url": "https://cdn.example.com/avatars/new.jpg"
}
```

#### 取得在線用戶列表

```
GET /api/v1/users/online
Authorization: Bearer {token}
```

**Query Parameters**:
| 參數 | 類型 | 說明 |
|------|------|------|
| room_id | uuid | 指定聊天室的在線成員 |
| page | int | 頁碼 |
| per_page | int | 每頁數量 (預設 50) |

### 8.5 聊天室 API

#### 建立聊天室

```
POST /api/v1/rooms
Authorization: Bearer {token}
```

**Request Body**:
```json
{
  "name": "技術討論區",
  "description": "討論程式開發相關話題",
  "type": "public",
  "max_members": 200
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "data": {
    "id": "660e8400-e29b-41d4-a716-446655440001",
    "name": "技術討論區",
    "description": "討論程式開發相關話題",
    "type": "public",
    "owner": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "john_doe"
    },
    "member_count": 1,
    "created_at": "2026-01-09T10:30:00Z"
  }
}
```

#### 取得聊天室列表

```
GET /api/v1/rooms
Authorization: Bearer {token}
```

**Query Parameters**:
| 參數 | 類型 | 說明 |
|------|------|------|
| type | string | public/private/joined |
| search | string | 搜尋名稱 |
| page | int | 頁碼 |
| per_page | int | 每頁數量 |

#### 加入聊天室

```
POST /api/v1/rooms/:id/join
Authorization: Bearer {token}
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "joined_at": "2026-01-09T10:35:00Z",
    "role": "member"
  }
}
```

#### 離開聊天室

```
POST /api/v1/rooms/:id/leave
Authorization: Bearer {token}
```

#### 取得聊天室成員

```
GET /api/v1/rooms/:id/members
Authorization: Bearer {token}
```

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "user_id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "john_doe",
      "display_name": "John Doe",
      "avatar_url": "...",
      "role": "owner",
      "status": "online",
      "joined_at": "2026-01-09T10:30:00Z"
    }
  ],
  "meta": {
    "total": 25,
    "online_count": 12
  }
}
```

### 8.6 訊息 API

#### 取得歷史訊息

```
GET /api/v1/rooms/:id/messages
Authorization: Bearer {token}
```

**Query Parameters**:
| 參數 | 類型 | 說明 |
|------|------|------|
| before | uuid | 取此訊息之前的訊息 |
| after | uuid | 取此訊息之後的訊息 |
| limit | int | 數量限制 (預設 50, 最大 100) |

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "id": "770e8400-e29b-41d4-a716-446655440002",
      "sender": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "username": "john_doe",
        "display_name": "John Doe",
        "avatar_url": "..."
      },
      "content": "大家好！",
      "type": "text",
      "created_at": "2026-01-09T10:40:00Z",
      "is_edited": false
    }
  ],
  "meta": {
    "has_more": true,
    "oldest_id": "770e8400-e29b-41d4-a716-446655440001"
  }
}
```

#### 標記已讀

```
POST /api/v1/rooms/:id/messages/read
Authorization: Bearer {token}
```

**Request Body**:
```json
{
  "last_read_message_id": "770e8400-e29b-41d4-a716-446655440002"
}
```

### 8.7 私訊 API

#### 取得對話列表

```
GET /api/v1/direct-messages/conversations
Authorization: Bearer {token}
```

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "user": {
        "id": "880e8400-e29b-41d4-a716-446655440003",
        "username": "jane_doe",
        "display_name": "Jane",
        "avatar_url": "...",
        "status": "online"
      },
      "last_message": {
        "content": "好的，晚點聊！",
        "created_at": "2026-01-09T10:45:00Z",
        "is_mine": false
      },
      "unread_count": 2
    }
  ]
}
```

#### 取得私訊歷史

```
GET /api/v1/direct-messages/:user_id
Authorization: Bearer {token}
```

#### 發送私訊

```
POST /api/v1/direct-messages/:user_id
Authorization: Bearer {token}
```

**Request Body**:
```json
{
  "content": "嗨！有空聊聊嗎？"
}
```

### 8.8 檔案上傳 API

#### 上傳檔案

```
POST /api/v1/files/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**Form Data**:
| 欄位 | 類型 | 說明 |
|------|------|------|
| file | file | 檔案 (最大 10MB) |
| type | string | image/file |

**Response**:
```json
{
  "success": true,
  "data": {
    "file_id": "990e8400-e29b-41d4-a716-446655440004",
    "file_url": "https://cdn.example.com/uploads/abc123.jpg",
    "file_name": "screenshot.jpg",
    "file_size": 256000,
    "mime_type": "image/jpeg"
  }
}
```

---

## 9. WebSocket 協議設計

### 9.1 連線建立

**連線端點**:
```
wss://api.example.com/ws?token={jwt_token}
```

**連線流程**:
```
Client                                  Server
   │                                       │
   │  1. WebSocket Handshake + JWT Token   │
   ├──────────────────────────────────────>│
   │                                       │
   │  2. Validate Token                    │
   │                                       │
   │  3. Connection Established            │
   │<──────────────────────────────────────┤
   │                                       │
   │  4. Send Connected Event              │
   │<──────────────────────────────────────┤
   │                                       │
   │  5. Subscribe to Rooms                │
   ├──────────────────────────────────────>│
   │                                       │
```

### 9.2 訊息格式

所有 WebSocket 訊息使用 JSON 格式:

```json
{
  "type": "message_type",
  "payload": { ... },
  "timestamp": "2026-01-09T10:30:00Z"
}
```

### 9.3 客戶端發送訊息類型

#### 加入聊天室

```json
{
  "type": "join_room",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001"
  }
}
```

#### 離開聊天室

```json
{
  "type": "leave_room",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001"
  }
}
```

#### 發送訊息

```json
{
  "type": "send_message",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "content": "大家好！",
    "message_type": "text",
    "temp_id": "client-temp-001"
  }
}
```

#### 發送私訊

```json
{
  "type": "send_direct_message",
  "payload": {
    "receiver_id": "880e8400-e29b-41d4-a716-446655440003",
    "content": "嗨！",
    "temp_id": "client-temp-002"
  }
}
```

#### 輸入中狀態

```json
{
  "type": "typing",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "is_typing": true
  }
}
```

#### 標記已讀

```json
{
  "type": "mark_read",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "message_id": "770e8400-e29b-41d4-a716-446655440002"
  }
}
```

#### 心跳 (Ping)

```json
{
  "type": "ping"
}
```

### 9.4 伺服器推送訊息類型

#### 連線成功

```json
{
  "type": "connected",
  "payload": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "session_id": "sess-abc123",
    "server_time": "2026-01-09T10:30:00Z"
  }
}
```

#### 新訊息

```json
{
  "type": "new_message",
  "payload": {
    "id": "770e8400-e29b-41d4-a716-446655440002",
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "sender": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "john_doe",
      "display_name": "John Doe",
      "avatar_url": "..."
    },
    "content": "大家好！",
    "type": "text",
    "created_at": "2026-01-09T10:40:00Z",
    "temp_id": "client-temp-001"
  }
}
```

#### 新私訊

```json
{
  "type": "new_direct_message",
  "payload": {
    "id": "880e8400-e29b-41d4-a716-446655440004",
    "sender": {
      "id": "880e8400-e29b-41d4-a716-446655440003",
      "username": "jane_doe",
      "display_name": "Jane"
    },
    "content": "你好！",
    "created_at": "2026-01-09T10:45:00Z"
  }
}
```

#### 用戶加入聊天室

```json
{
  "type": "user_joined",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "user": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "username": "john_doe",
      "display_name": "John Doe"
    },
    "timestamp": "2026-01-09T10:35:00Z"
  }
}
```

#### 用戶離開聊天室

```json
{
  "type": "user_left",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "timestamp": "2026-01-09T11:00:00Z"
  }
}
```

#### 用戶狀態變更

```json
{
  "type": "user_status_changed",
  "payload": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "away",
    "timestamp": "2026-01-09T11:30:00Z"
  }
}
```

#### 輸入中通知

```json
{
  "type": "user_typing",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "user": {
      "id": "880e8400-e29b-41d4-a716-446655440003",
      "display_name": "Jane"
    },
    "is_typing": true
  }
}
```

#### 訊息已讀回執

```json
{
  "type": "message_read",
  "payload": {
    "room_id": "660e8400-e29b-41d4-a716-446655440001",
    "message_id": "770e8400-e29b-41d4-a716-446655440002",
    "user_id": "880e8400-e29b-41d4-a716-446655440003",
    "read_at": "2026-01-09T10:42:00Z"
  }
}
```

#### 心跳回應 (Pong)

```json
{
  "type": "pong",
  "payload": {
    "server_time": "2026-01-09T10:30:05Z"
  }
}
```

#### 錯誤訊息

```json
{
  "type": "error",
  "payload": {
    "code": "ROOM_NOT_FOUND",
    "message": "聊天室不存在",
    "request_type": "join_room"
  }
}
```

### 9.5 心跳機制

```
┌────────────────────────────────────────────────────────────────┐
│                       心跳檢測機制                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Client                                Server                  │
│     │                                    │                     │
│     │  ─────────────────────────────>    │                     │
│     │         Ping (每 30 秒)            │                     │
│     │                                    │                     │
│     │  <─────────────────────────────    │                     │
│     │         Pong                       │                     │
│     │                                    │                     │
│     │         [Timeout: 10 秒]           │                     │
│     │                                    │                     │
│     │  若 60 秒無活動 ──> 斷開連線       │                     │
│     │                                    │                     │
└────────────────────────────────────────────────────────────────┘

設定參數:
- Ping 間隔: 30 秒
- Pong 超時: 10 秒
- 連線超時: 60 秒
- 寫入超時: 10 秒
- 讀取緩衝: 4096 bytes
- 寫入緩衝: 4096 bytes
```

---

## 10. 非功能性需求

### 10.1 效能需求

| 項目 | 要求 | 說明 |
|------|------|------|
| 單機併發連線 | 10,000+ | 單一 Go 伺服器支援的 WebSocket 連線數 |
| 訊息延遲 | < 100ms | 訊息從發送到接收的端到端延遲 |
| API 回應時間 | < 200ms | 95th percentile |
| 訊息廣播時間 | < 50ms | 廣播到聊天室所有成員的時間 |
| 每秒訊息處理量 | 50,000+ | 系統每秒可處理的訊息數 |
| 連線建立時間 | < 500ms | WebSocket 連線握手完成時間 |
| 歷史訊息載入 | < 300ms | 載入 50 筆歷史訊息 |

### 10.2 併發處理設計

```
┌────────────────────────────────────────────────────────────────┐
│                     Go 併發處理架構                             │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  每個 Client 連線:                                             │
│  ┌────────────────────────────────────────────────────────┐   │
│  │  readPump Goroutine   │   writePump Goroutine         │   │
│  │  - 處理接收訊息        │   - 處理發送訊息               │   │
│  │  - 非阻塞讀取          │   - 緩衝通道寫入               │   │
│  │  - 心跳檢測            │   - 批次發送                   │   │
│  └────────────────────────────────────────────────────────┘   │
│                              │                                 │
│                              ▼                                 │
│  ┌────────────────────────────────────────────────────────┐   │
│  │                    Hub Goroutine                       │   │
│  │  - 單一 Goroutine 管理所有連線                          │   │
│  │  - 使用 Channel 避免鎖競爭                              │   │
│  │  - O(1) 連線註冊/取消註冊                               │   │
│  └────────────────────────────────────────────────────────┘   │
│                                                                │
│  Channel 緩衝設定:                                             │
│  - client.send: 256 messages                                  │
│  - hub.broadcast: 1024 messages                               │
│  - hub.register/unregister: 256 requests                      │
│                                                                │
│  記憶體估算 (10,000 連線):                                     │
│  - 每連線 Goroutine: ~2KB stack                               │
│  - 每連線緩衝: ~8KB                                           │
│  - 總計: ~100MB                                               │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 10.3 可擴展性需求

| 項目 | 說明 |
|------|------|
| 水平擴展 | 支援多節點部署，透過 Redis Pub/Sub 同步訊息 |
| 負載均衡 | 支援 Sticky Session 或 IP Hash 分配 |
| 資料庫分片 | 預留訊息表分片能力 (按時間範圍) |
| 快取策略 | Redis 快取熱點資料 (在線狀態、聊天室成員) |

### 10.4 安全需求

| 項目 | 說明 |
|------|------|
| 認證機制 | JWT Token，有效期 24 小時 |
| 密碼安全 | bcrypt 加密，cost factor 12 |
| 傳輸加密 | WSS (WebSocket Secure) / HTTPS |
| 輸入驗證 | 訊息內容 XSS 過濾、長度限制 |
| 速率限制 | 每用戶每秒最多 10 則訊息 |
| 連線限制 | 每用戶最多 5 個同時連線 |
| CORS | 限制允許的 Origin |

### 10.5 可用性需求

| 項目 | 要求 |
|------|------|
| 系統可用性 | 99.9% (允許每月 ~43 分鐘停機) |
| 斷線重連 | 自動重連機制，最多重試 5 次 |
| 訊息持久化 | 所有訊息存入資料庫 |
| 離線訊息 | 重連後推送離線期間訊息 |
| 優雅關機 | 通知所有連線用戶，等待訊息處理完成 |

### 10.6 監控需求

| 監控項目 | 指標 |
|---------|------|
| 連線數 | 當前活躍 WebSocket 連線數 |
| 訊息量 | 每秒訊息發送/接收數 |
| 延遲 | 訊息處理延遲 P50/P95/P99 |
| 錯誤率 | 連線失敗率、訊息發送失敗率 |
| Goroutine 數量 | 當前 Goroutine 數量 |
| 記憶體使用 | Heap/Stack 使用量 |
| CPU 使用率 | Go runtime CPU 使用率 |

### 10.7 瀏覽器支援

| 瀏覽器 | 版本 |
|--------|------|
| Chrome | 最新 2 個主版本 |
| Firefox | 最新 2 個主版本 |
| Safari | 最新 2 個主版本 |
| Edge | 最新 2 個主版本 |

---

## 11. 名詞定義

| 名詞 | 英文 | 定義 |
|------|------|------|
| WebSocket | - | 全雙工通訊協議，允許伺服器主動推送訊息給客戶端 |
| Goroutine | - | Go 語言的輕量級執行緒，由 Go runtime 管理 |
| Channel | - | Go 語言中用於 Goroutine 間通訊的管道 |
| Hub | - | 管理所有 WebSocket 連線的中心樞紐 |
| Room | 聊天室 | 一群用戶組成的聊天空間 |
| Direct Message | 私訊 | 一對一的私人訊息 |
| Broadcast | 廣播 | 將訊息發送給多個接收者 |
| Pub/Sub | 發布/訂閱 | 訊息傳遞模式，發布者發送訊息，訂閱者接收訊息 |
| JWT | JSON Web Token | 用於認證的令牌格式 |
| Sticky Session | 黏性會話 | 確保同一用戶的請求總是被路由到同一伺服器 |

---

## 版本歷史

| 版本 | 日期 | 修改內容 | 作者 |
|------|------|---------|------|
| 1.0 | 2026-01-09 | 初版建立 | Kamesan |

---

**文件結束**
