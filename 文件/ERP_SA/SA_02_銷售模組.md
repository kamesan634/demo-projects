# 零售業簡易ERP系統 - 銷售模組 SA文件

**文件版本**: v1.0
**建立日期**: 2025-12-31
**模組代碼**: M03
**關聯主文件**: [SA_00_主文件.md](SA_00_主文件.md)

---

## 目錄

1. [模組概述](#1-模組概述)
2. [POS銷售作業](#2-pos銷售作業)
3. [訂單管理](#3-訂單管理)
4. [退換貨處理](#4-退換貨處理)
5. [促銷活動管理](#5-促銷活動管理)
6. [會員優惠](#6-會員優惠)
7. [收銀班別管理](#7-收銀班別管理)
8. [發票管理](#8-發票管理)
9. [系統流程圖](#9-系統流程圖)
10. [資料表設計](#10-資料表設計)
11. [API規格](#11-api規格)

---

## 1. 模組概述

### 1.1 模組說明

銷售模組是零售ERP系統的核心作業模組，提供完整的POS收銀、訂單管理、退換貨、促銷活動、會員優惠等功能，支援多種付款方式與發票開立。

### 1.2 功能清單

| 功能代碼 | 功能名稱 | 優先順序 |
|---------|---------|:-------:|
| F05-001 | POS結帳介面 | P0 |
| F05-002 | 付款處理 | P0 |
| F05-003 | 訂單管理 | P0 |
| F05-004 | 退換貨處理 | P0 |
| F05-005 | 促銷活動管理 | P1 |
| F05-006 | 掛單管理 | P1 |
| F05-007 | 收銀班別管理 | P1 |
| F05-008 | 發票管理 | P1 |
| F05-009 | 會員識別與優惠 | P0 |

### 1.3 模組關聯

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  商品管理   │────>│   銷售模組   │<────│  客戶管理   │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
              ▼            ▼            ▼
       ┌───────────┐ ┌───────────┐ ┌───────────┐
       │  庫存扣減  │ │  點數累積  │ │  報表統計  │
       └───────────┘ └───────────┘ └───────────┘
```

---

## 2. POS銷售作業

### 2.1 POS結帳介面 (F05-001)

**功能說明**: 提供直覺化的收銀結帳操作介面，支援觸控與鍵盤操作。

#### 介面配置

```
┌────────────────────────────────────────────────────────────────────┐
│  [商品搜尋 🔍]                              [收銀員: 王小明] [登出] │
├──────────────────────────────────┬─────────────────────────────────┤
│                                  │   購物車                        │
│   商品快速鍵區                   │   ────────────────────          │
│   ┌──────┬──────┬──────┬──────┐ │   商品名稱        數量    小計   │
│   │ 商品1 │ 商品2 │ 商品3 │ 商品4 │ │   ────────────────────          │
│   │ $99  │ $199 │ $299 │ $399 │ │   白色T-Shirt     x2    $598   │
│   ├──────┼──────┼──────┼──────┤ │   [編輯] [刪除]                 │
│   │ 商品5 │ 商品6 │ 商品7 │ 商品8 │ │                                 │
│   │ $149 │ $249 │ $349 │ $449 │ │   黑色長褲        x1    $890   │
│   ├──────┼──────┼──────┼──────┤ │   [編輯] [刪除]                 │
│   │ 商品9 │商品10│商品11│商品12│ │                                 │
│   │ $199 │ $299 │ $399 │ $499 │ │   皮帶            x1    $450   │
│   └──────┴──────┴──────┴──────┘ │   [編輯] [刪除]                 │
│                                  │   ────────────────────          │
│   分類快捷:                      │                                 │
│   [上衣] [褲子] [配件] [鞋類]    │   商品數量:          4 件       │
│                                  │   小    計:      $1,938        │
├──────────────────────────────────┤   折    扣:        -$97        │
│                                  │   稅    額:         $92        │
│  會員: 陳小華 (金卡 5%折扣)      │   ════════════════════          │
│  可用點數: 1,250 點              │   應收金額:      $1,933        │
│                                  │                                 │
├──────────────────────────────────┼─────────────────────────────────┤
│ [F1會員] [F2數量] [F3折扣]       │                                 │
│ [F4備註] [F5取消] [F6清空]       │  [現金F9] [信用卡F10] [其他F11] │
│ [F7掛單] [F8取單]                │        [結帳 F12]               │
└──────────────────────────────────┴─────────────────────────────────┘
```

#### 快捷鍵對照

| 快捷鍵 | 功能 | 說明 |
|:------:|------|------|
| F1 | 會員查詢 | 輸入會員卡號/手機 |
| F2 | 數量修改 | 修改選取項目數量 |
| F3 | 單項折扣 | 對單一商品折扣 |
| F4 | 備註 | 加入訂單備註 |
| F5 | 取消項目 | 取消選取的商品 |
| F6 | 清空 | 清空購物車 |
| F7 | 掛單 | 暫存目前交易 |
| F8 | 取單 | 取回掛單交易 |
| F9 | 現金結帳 | 現金付款 |
| F10 | 信用卡 | 信用卡付款 |
| F11 | 其他付款 | 其他付款方式 |
| F12 | 結帳 | 進入結帳流程 |
| ESC | 返回 | 取消目前操作 |
| Enter | 確認 | 確認輸入/選擇 |
| ↑↓ | 選擇 | 選擇購物車項目 |

#### 商品輸入方式

| 方式 | 說明 |
|------|------|
| 條碼掃描 | 掃描商品條碼自動加入 |
| 編號輸入 | 輸入商品編號 + Enter |
| 快速鍵 | 點擊商品快速鍵 |
| 搜尋選擇 | 關鍵字搜尋後選擇 |

---

### 2.2 付款處理 (F05-002)

**功能說明**: 處理各種付款方式的結帳流程，支援複合付款。

#### 付款流程

```
┌──────────────────┐
│   顯示應收金額   │
│     $1,933      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│   選擇付款方式   │
│ ┌────┐ ┌────┐   │
│ │現金│ │信用卡│   │
│ └────┘ └────┘   │
│ ┌────┐ ┌────┐   │
│ │行動支付│ │禮券│  │
│ └────┘ └────┘   │
└────────┬─────────┘
         │
    ┌────┴────┐
    ▼         ▼
[單一付款]  [複合付款]
    │         │
    ▼         ▼
┌─────────┐ ┌─────────────┐
│處理付款 │ │ 分次輸入    │
│         │ │ 各付款金額  │
└────┬────┘ └──────┬──────┘
     │             │
     └──────┬──────┘
            ▼
     ┌─────────────┐
     │  完成交易   │
     │  列印收據   │
     │  開立發票   │
     └─────────────┘
```

#### 各付款方式處理

**現金付款**:
| 步驟 | 操作 |
|------|------|
| 1 | 選擇現金付款 |
| 2 | 輸入收款金額 |
| 3 | 系統計算找零 |
| 4 | 確認完成 |

**信用卡付款**:
| 步驟 | 操作 |
|------|------|
| 1 | 選擇信用卡付款 |
| 2 | 刷卡/插卡 |
| 3 | 輸入卡號末四碼 |
| 4 | 輸入授權碼 |
| 5 | 確認完成 |

**行動支付**:
| 步驟 | 操作 |
|------|------|
| 1 | 選擇行動支付 |
| 2 | 選擇支付方式 (Line Pay/街口等) |
| 3 | 顯示付款QR Code 或 掃描客戶QR Code |
| 4 | 等待付款確認 |
| 5 | 確認完成 |

#### 複合付款範例

```
┌────────────────────────────────────┐
│          複合付款                  │
├────────────────────────────────────┤
│  應收金額:              $1,933     │
│  ─────────────────────────────     │
│  付款方式1: [禮券 ▼]    $500      │
│  付款方式2: [點數 ▼]    $200      │
│  付款方式3: [現金 ▼]  $1,233      │
│  ─────────────────────────────     │
│  已收金額:              $1,933     │
│  剩餘金額:                  $0     │
│                                    │
│        [取消]    [確認付款]        │
└────────────────────────────────────┘
```

#### 付款方式設定欄位

| 欄位 | 說明 |
|------|------|
| 付款方式 | 選擇付款類型 |
| 付款金額 | 此方式支付金額 |
| 卡號末四碼 | 信用卡需要 |
| 授權碼 | 信用卡需要 |
| 備註 | 特殊說明 |

---

### 2.3 掛單管理 (F05-006)

**功能說明**: 暫存未完成交易，供後續繼續結帳。

#### 使用情境

- 客戶臨時需要離開取物
- 等待商品確認或調貨
- 需切換服務其他客戶
- 等待主管授權折扣

#### 掛單資訊

| 欄位 | 說明 |
|------|------|
| 掛單編號 | 自動產生 |
| 掛單時間 | 系統時間 |
| 操作員 | 目前收銀員 |
| 購物車內容 | 商品明細 |
| 會員資訊 | 若有登錄會員 |
| 備註 | 可輸入說明 |
| 狀態 | 掛單中/已取回/已過期 |

#### 掛單畫面

```
┌────────────────────────────────────────────┐
│              掛單列表                       │
├────────────────────────────────────────────┤
│ 編號    時間      金額     會員    狀態     │
│ ─────────────────────────────────────────  │
│ H001   10:30    $1,933   陳小華   掛單中   │
│        商品: 白T x2, 黑褲 x1, 皮帶 x1      │
│        [取回] [作廢]                        │
│ ─────────────────────────────────────────  │
│ H002   11:15    $2,580   -        掛單中   │
│        商品: 外套 x1, 帽子 x2              │
│        [取回] [作廢]                        │
│ ─────────────────────────────────────────  │
└────────────────────────────────────────────┘
```

#### 業務規則

| 規則編號 | 規則說明 |
|---------|---------|
| BR01 | 掛單保留24小時，逾期自動清除 |
| BR02 | 同一收銀員最多5筆掛單 |
| BR03 | 掛單可由任一收銀員取回 (同門市) |
| BR04 | 掛單取回後恢復到購物車 |
| BR05 | 掛單作廢需要原因說明 |

---

## 3. 訂單管理

### 3.1 訂單管理 (F05-003)

**功能說明**: 查詢與管理銷售訂單記錄。

#### 訂單狀態

| 狀態代碼 | 狀態名稱 | 說明 |
|---------|---------|------|
| COMPLETED | 已完成 | 正常完成的訂單 |
| VOIDED | 已作廢 | 整筆作廢的訂單 |
| REFUNDED | 已退貨 | 全額退貨的訂單 |
| PARTIAL_REFUND | 部分退貨 | 部分商品退貨 |

#### 查詢條件

| 條件 | 類型 | 說明 |
|------|------|------|
| 訂單編號 | 文字 | 精確查詢 |
| 日期範圍 | 日期 | 起訖日期 |
| 門市 | 下拉 | 單選/多選 |
| 收銀員 | 下拉 | 單選 |
| 付款方式 | 下拉 | 多選 |
| 金額範圍 | 數值 | 起訖金額 |
| 會員 | 文字 | 會員編號/姓名/手機 |
| 狀態 | 下拉 | 訂單狀態 |
| 商品 | 文字 | 包含特定商品 |

#### 訂單列表欄位

| 欄位 | 說明 |
|------|------|
| 訂單編號 | 連結至詳情 |
| 訂單日期 | 日期時間 |
| 門市 | 交易門市 |
| 收銀員 | 經手人 |
| 會員 | 會員姓名 (非會員顯示-) |
| 商品數 | 商品項目數 |
| 訂單金額 | 總金額 |
| 付款方式 | 主要付款方式 |
| 狀態 | 訂單狀態 |
| 操作 | 檢視/退貨/作廢 |

#### 訂單詳情

```
┌────────────────────────────────────────────────────────────────┐
│ 訂單詳情                                            [列印] [X] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ 訂單編號: SO202512310001         訂單日期: 2025-12-31 14:30   │
│ 門    市: 台北旗艦店             收 銀 員: 王小明              │
│ 會    員: 陳小華 (金卡)          狀    態: 已完成 ✓            │
│                                                                │
│ ┌─ 商品明細 ──────────────────────────────────────────────┐   │
│ │ 商品名稱          單價     數量    折扣    小計          │   │
│ │ ──────────────────────────────────────────────────────  │   │
│ │ 白色T-Shirt      $299      2      -       $598          │   │
│ │ 黑色長褲         $890      1      -       $890          │   │
│ │ 皮帶             $450      1      -       $450          │   │
│ │ ──────────────────────────────────────────────────────  │   │
│ │ 商品小計:                               $1,938          │   │
│ │ 會員折扣 (5%):                            -$97          │   │
│ │ 營業稅:                                    $92          │   │
│ │ ══════════════════════════════════════════════════════  │   │
│ │ 訂單總計:                               $1,933          │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│ ┌─ 付款資訊 ──────────────────────────────────────────────┐   │
│ │ 付款方式          金額          備註                     │   │
│ │ ──────────────────────────────────────────────────────  │   │
│ │ 現金             $2,000        收款 $2,000 / 找零 $67   │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│ ┌─ 發票資訊 ──────────────────────────────────────────────┐   │
│ │ 發票號碼: AB-12345678         發票類型: 電子發票         │   │
│ │ 載具類型: 手機條碼            載具號碼: /ABC1234         │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│ ┌─ 點數資訊 ──────────────────────────────────────────────┐   │
│ │ 本次獲得點數: 193 點          點數使用: 0 點             │   │
│ │ 會員累積點數: 1,443 點                                   │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│               [退貨]  [重印收據]  [重印發票]  [關閉]           │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. 退換貨處理

### 4.1 退換貨處理 (F05-004)

**功能說明**: 處理客戶退貨或換貨作業。

#### 退換貨類型

| 類型 | 說明 | 庫存影響 | 金額影響 |
|------|------|---------|---------|
| 退貨退款 | 商品退回，退還款項 | +入庫 | -營收 |
| 換貨 | 商品交換，可能補差價 | ±調整 | 補差價 |
| 僅退款 | 不退貨，退款 (特殊狀況) | 無 | -營收 |

#### 退貨原因

| 原因代碼 | 原因說明 |
|---------|---------|
| DEFECT | 商品瑕疵 |
| WRONG_SIZE | 尺寸不合 |
| WRONG_ITEM | 拿錯商品 |
| NOT_SATISFIED | 顧客不滿意 |
| DUPLICATE | 重複購買 |
| OTHER | 其他原因 |

#### 退貨流程

```
[開始]
   │
   ▼
┌──────────────────┐
│ 輸入原訂單編號   │
│ 或掃描收據條碼   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ 查詢訂單是否存在 │──否─>│ 顯示錯誤訊息     │
└────────┬─────────┘     └──────────────────┘
         │是
         ▼
┌──────────────────┐
│ 顯示訂單商品明細 │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 選擇退貨商品     │
│ 輸入退貨數量     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 選擇退貨原因     │
│ 輸入備註說明     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 系統計算退款金額 │
│ (含稅、折扣還原) │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ 金額超過限制?    │──是─>│ 主管授權         │
└────────┬─────────┘     └────────┬─────────┘
         │否                      │
         ▼                        │
┌──────────────────┐◄─────────────┘
│ 選擇退款方式     │
│ • 原付款方式     │
│ • 現金           │
│ • 購物金/點數    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 確認退貨         │
│ • 更新訂單狀態   │
│ • 庫存回補       │
│ • 扣減會員點數   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 列印退貨單       │
└────────┬─────────┘
         │
         ▼
[結束]
```

#### 退貨單欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 退貨單號 | VARCHAR(30) | Y | 自動產生 |
| 原訂單號 | VARCHAR(30) | Y | 關聯原訂單 |
| 退貨日期 | DATETIME | Y | 系統時間 |
| 退貨類型 | ENUM | Y | 退貨/換貨/僅退款 |
| 退貨原因 | ENUM | Y | 原因代碼 |
| 原因說明 | TEXT | N | 詳細說明 |
| 退貨商品 | JSON | Y | 商品明細 |
| 退款金額 | DECIMAL(12,2) | Y | - |
| 退款方式 | ENUM | Y | - |
| 處理人員 | INT (FK) | Y | - |
| 授權主管 | INT (FK) | N | 超過限制時 |

#### 業務規則

| 規則編號 | 規則說明 |
|---------|---------|
| BR01 | 退貨需在購買後N天內 (可設定，預設7天) |
| BR02 | 退款金額不可超過原購買金額 |
| BR03 | 超過設定金額 (如$5,000) 需主管授權 |
| BR04 | 需檢查商品退貨政策 (部分商品不可退) |
| BR05 | 已使用的點數折抵需從退款中扣除 |
| BR06 | 退貨後扣減原獲得的會員點數 |
| BR07 | 換貨時庫存一進一出 |

#### 退貨畫面

```
┌────────────────────────────────────────────────────────────────┐
│ 退貨作業                                                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ 原訂單編號: [SO202512310001    ] [查詢]                        │
│                                                                │
│ ┌─ 訂單資訊 ──────────────────────────────────────────────┐   │
│ │ 訂單日期: 2025-12-31  會員: 陳小華  金額: $1,933        │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│ ┌─ 選擇退貨商品 ──────────────────────────────────────────┐   │
│ │ ☑ 白色T-Shirt     $299 x [2▼] (原購2件)    退款: $598   │   │
│ │ ☐ 黑色長褲        $890 x [0▼] (原購1件)    退款: $0     │   │
│ │ ☐ 皮帶            $450 x [0▼] (原購1件)    退款: $0     │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│ 退貨原因: [商品瑕疵 ▼]                                         │
│ 原因說明: [T-Shirt有汙漬                                    ]  │
│                                                                │
│ ┌─ 退款計算 ──────────────────────────────────────────────┐   │
│ │ 商品退款:                                       $598     │   │
│ │ 折扣還原:                                       +$30     │   │
│ │ 點數扣減:                                 -60點 ($60)    │   │
│ │ ───────────────────────────────────────────────────     │   │
│ │ 應退金額:                                       $568     │   │
│ └─────────────────────────────────────────────────────────┘   │
│                                                                │
│ 退款方式: ● 現金  ○ 原付款方式  ○ 購物金                       │
│                                                                │
│                    [取消]              [確認退貨]              │
└────────────────────────────────────────────────────────────────┘
```

---

## 5. 促銷活動管理

### 5.1 促銷活動管理 (F05-005)

**功能說明**: 設定各種促銷折扣活動。

#### 促銷類型

| 類型代碼 | 類型名稱 | 說明 | 範例 |
|---------|---------|------|------|
| ITEM_DISCOUNT | 單品折扣 | 特定商品降價 | A商品特價$99 |
| ITEM_PERCENT | 單品折數 | 特定商品打折 | A商品85折 |
| COMBO | 組合優惠 | 買特定組合享優惠 | 任選3件$500 |
| THRESHOLD_DISCOUNT | 滿額折扣 | 消費滿額折抵 | 滿$1000折$100 |
| THRESHOLD_PERCENT | 滿額折數 | 消費滿額打折 | 滿$2000享9折 |
| THRESHOLD_GIFT | 滿額贈 | 消費滿額送贈品 | 滿$2000送購物袋 |
| BUY_X_GET_Y | 買N送M | 買幾送幾 | 買2送1 |
| NTH_PERCENT | 第N件折扣 | 第N件打折 | 第2件6折 |
| MEMBER_ONLY | 會員專屬 | 僅會員適用 | 會員日全館9折 |
| COUPON | 折扣碼 | 輸入代碼折扣 | 輸入CODE享95折 |

#### 促銷設定欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 活動代碼 | VARCHAR(30) | Y | 唯一值 |
| 活動名稱 | NVARCHAR(100) | Y | - |
| 活動描述 | NVARCHAR(500) | N | 顯示給客戶 |
| 促銷類型 | ENUM | Y | 見上表 |
| 開始時間 | DATETIME | Y | - |
| 結束時間 | DATETIME | Y | - |
| 適用商品 | JSON | N | NULL=全商品 |
| 適用分類 | JSON | N | - |
| 排除商品 | JSON | N | 不適用的商品 |
| 適用門市 | JSON | N | NULL=全門市 |
| 適用會員等級 | JSON | N | NULL=全部 |
| 促銷條件 | JSON | Y | 觸發條件 |
| 優惠內容 | JSON | Y | 折扣內容 |
| 使用上限 | INT | N | 每人使用次數 |
| 總量上限 | INT | N | 活動總使用次數 |
| 可併用 | BOOLEAN | Y | 可與其他優惠併用 |
| 優先順序 | INT | Y | 多促銷時的優先級 |
| 狀態 | ENUM | Y | DRAFT/ACTIVE/INACTIVE/EXPIRED |

#### 促銷條件設定範例

**滿額折扣**:
```json
{
  "type": "THRESHOLD_DISCOUNT",
  "condition": {
    "min_amount": 1000
  },
  "discount": {
    "type": "FIXED",
    "value": 100
  }
}
```

**買2送1**:
```json
{
  "type": "BUY_X_GET_Y",
  "condition": {
    "buy_quantity": 2,
    "apply_to": "SAME_PRODUCT"
  },
  "discount": {
    "free_quantity": 1,
    "apply_to": "CHEAPEST"
  }
}
```

**第2件6折**:
```json
{
  "type": "NTH_PERCENT",
  "condition": {
    "nth_item": 2,
    "apply_to": "SAME_CATEGORY"
  },
  "discount": {
    "type": "PERCENT",
    "value": 40
  }
}
```

**任選3件$500**:
```json
{
  "type": "COMBO",
  "condition": {
    "min_quantity": 3,
    "apply_to": "SELECTED_PRODUCTS"
  },
  "discount": {
    "type": "FIXED_TOTAL",
    "value": 500
  }
}
```

#### 促銷計算優先順序

```
1. 折扣碼優惠 (手動輸入)
        │
        ▼
2. 會員等級折扣 (自動套用)
        │
        ▼
3. 商品促銷價 (特價商品)
        │
        ▼
4. 組合優惠 (滿額、買N送M等)
        │
        ▼
5. 點數折抵 (最後套用)
```

---

## 6. 會員優惠

### 6.1 會員識別與優惠 (F05-009)

**功能說明**: 在銷售過程中識別會員並套用對應優惠。

#### 會員識別方式

| 方式 | 操作說明 |
|------|---------|
| 會員卡號 | 輸入或掃描實體會員卡 |
| 手機號碼 | 輸入會員手機號碼 |
| App QR Code | 掃描會員App的QR Code |
| 姓名查詢 | 輸入姓名模糊搜尋 |

#### 會員優惠類型

| 優惠類型 | 說明 | 計算方式 |
|---------|------|---------|
| 會員價 | 商品專屬會員價格 | 取代標準售價 |
| 等級折扣 | 依會員等級享折扣 | 訂單總額 × 折扣率 |
| 點數折抵 | 使用累積點數 | 點數 × 點數價值 |
| 專屬優惠券 | 會員專屬coupon | 依coupon設定 |
| 生日優惠 | 生日當月優惠 | 依活動設定 |

#### 優惠套用順序

```
1. 檢查商品是否有會員價 ──有──> 使用會員價
        │
        │ 無
        ▼
2. 檢查是否有適用促銷 ──有──> 套用促銷價
        │
        │ 無
        ▼
3. 使用標準售價
        │
        ▼
4. 計算訂單小計
        │
        ▼
5. 套用會員等級折扣
        │
        ▼
6. 詢問是否使用點數折抵
        │
        ▼
7. 計算最終應付金額
```

#### 會員資訊顯示

```
┌─────────────────────────────────────────┐
│ 會員資訊                                │
├─────────────────────────────────────────┤
│ 姓名: 陳小華                            │
│ 等級: 金卡會員 ⭐⭐⭐                    │
│ 手機: 0912-345-678                      │
│ ────────────────────────────────────    │
│ 累積消費: $35,280                       │
│ 距離升級: 還需 $64,720 升白金卡         │
│ ────────────────────────────────────    │
│ 可用點數: 1,250 點 (可折抵 $1,250)      │
│ 會員折扣: 5%                            │
│ ────────────────────────────────────    │
│ 本次獲得: 預估 193 點                   │
│ ────────────────────────────────────    │
│ 優惠券: 2 張可用 [查看]                 │
└─────────────────────────────────────────┘
```

---

## 7. 收銀班別管理

### 7.1 收銀班別管理 (F05-007)

**功能說明**: 管理收銀員的交班與日結作業。

#### 班別操作

| 操作 | 說明 | 執行時機 |
|------|------|---------|
| 開班 | 開始營業，輸入初始現金 | 上班/換班開始 |
| 交班 | 切換收銀員，清點現金 | 換班時 |
| 日結 | 結束營業，產生日結報表 | 營業結束 |

#### 開班流程

```
1. 登入系統
        │
        ▼
2. 選擇收銀機台
        │
        ▼
3. 輸入初始現金金額
        │
        ▼
4. 確認開班
        │
        ▼
5. 開始營業
```

#### 交班/日結流程

```
1. 點擊交班/日結
        │
        ▼
2. 系統顯示班別統計
        │
        ▼
3. 清點實際現金
        │
        ▼
4. 輸入各幣值數量
   ┌──────────────────────┐
   │ 1000元 x [  ] = $    │
   │  500元 x [  ] = $    │
   │  100元 x [  ] = $    │
   │   50元 x [  ] = $    │
   │   10元 x [  ] = $    │
   │    5元 x [  ] = $    │
   │    1元 x [  ] = $    │
   │ ─────────────────    │
   │ 合計:         $      │
   └──────────────────────┘
        │
        ▼
5. 系統計算差額
        │
        ▼
6. 差額說明 (如有)
        │
        ▼
7. 主管確認 (如有差額)
        │
        ▼
8. 列印班別報表
        │
        ▼
9. 完成交班/日結
```

#### 班別報表

```
═══════════════════════════════════════════════════════
              收銀班別結帳報表
═══════════════════════════════════════════════════════
門市: 台北旗艦店                    收銀機: POS-01
收銀員: 王小明
班別: 2025-12-31 09:00 ~ 17:00

───────────────────────────────────────────────────────
【銷售統計】
  交易筆數:                              45 筆
  銷售數量:                             128 件
  銷售總額:                         $58,900
  退貨筆數:                               2 筆
  退貨金額:                          -$1,200
  折扣金額:                          -$2,950
  ─────────────────────────────────────────────────
  淨銷售額:                         $54,750

───────────────────────────────────────────────────────
【付款方式明細】
  現金:                             $32,500    (59.4%)
  信用卡:                           $18,700    (34.2%)
  Line Pay:                          $2,550     (4.7%)
  街口支付:                            $800     (1.5%)
  禮券:                                $200     (0.4%)
  ─────────────────────────────────────────────────
  合計:                             $54,750

───────────────────────────────────────────────────────
【現金清點】
  開班金額:                          $5,000
  現金收入:                         $32,500
  現金支出 (退款):                     -$800
  ─────────────────────────────────────────────────
  應有現金:                         $36,700
  實際清點:                         $36,680
  ─────────────────────────────────────────────────
  差    額:                            -$20   ⚠ 短少

───────────────────────────────────────────────────────
【會員統計】
  會員交易筆數:                         32 筆
  會員交易金額:                     $42,800
  點數發放:                          4,280 點
  點數使用:                          1,500 點

───────────────────────────────────────────────────────
差額說明: 找零誤差
主管確認: ____________

收銀員簽名: ____________
═══════════════════════════════════════════════════════
          列印時間: 2025-12-31 17:15:30
═══════════════════════════════════════════════════════
```

---

## 8. 發票管理

### 8.1 發票管理 (F05-008)

**功能說明**: 開立與管理銷售發票。

#### 發票類型

| 類型 | 說明 | 適用對象 |
|------|------|---------|
| 電子發票 | B2C一般消費 | 一般消費者 |
| 電子發票-載具 | 存入載具 | 有載具的消費者 |
| 電子發票-捐贈 | 捐贈給公益團體 | 願意捐贈的消費者 |
| 三聯式發票 | B2B營業人發票 | 公司行號 |

#### 載具類型

| 載具類型 | 說明 |
|---------|------|
| 手機條碼 | /開頭的8碼條碼 |
| 自然人憑證 | 16碼大寫英數字 |
| 會員載具 | 公司自有會員載具 |

#### 發票開立欄位

| 欄位 | 資料型態 | 必填 | 說明 |
|------|---------|:----:|------|
| 發票號碼 | VARCHAR(12) | Y | 自動配號 |
| 發票日期 | DATE | Y | 交易日期 |
| 發票類型 | ENUM | Y | - |
| 買方統編 | VARCHAR(8) | N | 三聯式必填 |
| 買方名稱 | NVARCHAR(100) | N | 三聯式必填 |
| 載具類型 | ENUM | N | - |
| 載具號碼 | VARCHAR(20) | N | - |
| 捐贈碼 | VARCHAR(10) | N | 愛心碼 |
| 銷售額 | DECIMAL(12,2) | Y | 未稅金額 |
| 稅額 | DECIMAL(12,2) | Y | - |
| 總計 | DECIMAL(12,2) | Y | - |

#### 發票開立流程

```
┌──────────────────────────────────────┐
│           發票開立                    │
├──────────────────────────────────────┤
│                                      │
│  發票類型:                           │
│  ● 電子發票                          │
│  ○ 三聯式發票 (需統編)               │
│                                      │
│  ──────────────────────────────      │
│                                      │
│  ☐ 存入載具                          │
│    載具類型: [手機條碼 ▼]            │
│    載具號碼: [/ABC1234   ]           │
│                                      │
│  ☐ 捐贈發票                          │
│    捐贈碼: [愛心碼查詢]              │
│                                      │
│  ☐ 列印紙本                          │
│                                      │
│  ──────────────────────────────      │
│                                      │
│  銷售額: $1,841   稅額: $92          │
│  總  計: $1,933                      │
│                                      │
│         [取消]    [開立發票]         │
└──────────────────────────────────────┘
```

#### 發票作廢/折讓

| 操作 | 說明 | 條件 |
|------|------|------|
| 作廢 | 整張發票作廢 | 當月發票可作廢 |
| 折讓 | 部分金額折讓 | 跨月退貨使用 |

---

## 9. 系統流程圖

### 9.1 POS銷售完整流程

```
[開始]
   │
   ▼
┌──────────────┐
│   開班作業   │──> 輸入初始現金
└──────────────┘
   │
   ▼
┌──────────────┐     ┌──────────────┐
│  掃描/輸入   │────>│  查無商品?   │──是──> 顯示錯誤
│  商品條碼    │     └──────────────┘
└──────────────┘            │否
   │                        ▼
   │                 ┌──────────────┐
   │                 │ 加入購物車   │
   │                 │ 顯示商品資訊 │
   │                 │ 檢查促銷價   │
   │                 └──────────────┘
   │                        │
   ▼<───────────────────────┘
┌──────────────┐
│ 繼續掃描?    │──是──> [回到掃描]
└──────────────┘
   │否
   ▼
┌──────────────┐     ┌──────────────┐
│  會員登入?   │──是─>│ 查詢會員資訊 │
└──────────────┘     │ 套用會員優惠 │
   │否               │ 顯示可用點數 │
   │                 └──────────────┘
   ▼<───────────────────────┘
┌──────────────┐
│  套用促銷    │
│  計算折扣    │
│  計算稅額    │
└──────────────┘
   │
   ▼
┌──────────────┐     ┌──────────────┐
│  點數折抵?   │──是─>│ 輸入折抵點數 │
└──────────────┘     │ 調整應付金額 │
   │否               └──────────────┘
   ▼<───────────────────────┘
┌──────────────┐
│  選擇付款    │
│  方式        │
└──────────────┘
   │
   ├──────────────────────────┐
   ▼                          ▼
┌──────────────┐     ┌──────────────┐
│    現金      │     │  信用卡/其他 │
│ 輸入收款金額 │     │  付款處理    │
│ 計算找零     │     └──────────────┘
└──────────────┘            │
   │                        │
   ▼<───────────────────────┘
┌──────────────┐
│  完成交易    │
│  • 建立訂單  │
│  • 扣減庫存  │
│  • 累積點數  │
│  • 更新會員  │
└──────────────┘
   │
   ▼
┌──────────────┐
│  發票處理    │
│  • 載具/捐贈 │
│  • 開立發票  │
└──────────────┘
   │
   ▼
┌──────────────┐
│  列印收據    │
└──────────────┘
   │
   ▼
[結束/下一筆交易]
```

---

## 10. 資料表設計

### 10.1 訂單相關資料表

#### orders (銷售訂單)

```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(30) NOT NULL UNIQUE,
    store_id INT NOT NULL,
    pos_id VARCHAR(20),
    cashier_id INT NOT NULL,
    customer_id INT,
    order_date DATETIME NOT NULL,

    -- 金額
    subtotal DECIMAL(12,2) NOT NULL,
    discount_amount DECIMAL(12,2) DEFAULT 0,
    tax_amount DECIMAL(12,2) DEFAULT 0,
    total_amount DECIMAL(12,2) NOT NULL,

    -- 點數
    points_earned INT DEFAULT 0,
    points_used INT DEFAULT 0,
    points_amount DECIMAL(12,2) DEFAULT 0,

    -- 狀態
    status ENUM('COMPLETED', 'VOIDED', 'REFUNDED', 'PARTIAL_REFUND') DEFAULT 'COMPLETED',

    -- 促銷
    promotion_ids JSON,
    coupon_code VARCHAR(30),

    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (cashier_id) REFERENCES users(id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    INDEX idx_order_no (order_no),
    INDEX idx_store_date (store_id, order_date),
    INDEX idx_customer (customer_id)
);
```

#### order_items (訂單明細)

```sql
CREATE TABLE order_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    variant_id INT,
    product_name NVARCHAR(200) NOT NULL,
    sku VARCHAR(50),
    quantity INT NOT NULL,
    unit_price DECIMAL(12,2) NOT NULL,
    original_price DECIMAL(12,2) NOT NULL,
    discount_amount DECIMAL(12,2) DEFAULT 0,
    tax_amount DECIMAL(12,2) DEFAULT 0,
    subtotal DECIMAL(12,2) NOT NULL,
    cost_price DECIMAL(12,2),
    promotion_id INT,
    notes NVARCHAR(200),

    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_order (order_id),
    INDEX idx_product (product_id)
);
```

#### payments (付款紀錄)

```sql
CREATE TABLE payments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,
    payment_method VARCHAR(20) NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    received_amount DECIMAL(12,2),
    change_amount DECIMAL(12,2),
    card_last_four VARCHAR(4),
    auth_code VARCHAR(20),
    reference_no VARCHAR(50),
    status ENUM('SUCCESS', 'FAILED', 'REFUNDED') DEFAULT 'SUCCESS',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (order_id) REFERENCES orders(id),
    INDEX idx_order (order_id)
);
```

#### refunds (退貨單)

```sql
CREATE TABLE refunds (
    id INT PRIMARY KEY AUTO_INCREMENT,
    refund_no VARCHAR(30) NOT NULL UNIQUE,
    order_id INT NOT NULL,
    store_id INT NOT NULL,
    cashier_id INT NOT NULL,
    approver_id INT,
    refund_date DATETIME NOT NULL,
    refund_type ENUM('REFUND', 'EXCHANGE', 'REFUND_ONLY') NOT NULL,
    reason_code VARCHAR(20) NOT NULL,
    reason_note TEXT,
    refund_amount DECIMAL(12,2) NOT NULL,
    refund_method VARCHAR(20) NOT NULL,
    points_deducted INT DEFAULT 0,
    status ENUM('COMPLETED', 'CANCELLED') DEFAULT 'COMPLETED',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (order_id) REFERENCES orders(id),
    INDEX idx_refund_no (refund_no),
    INDEX idx_order (order_id)
);
```

#### refund_items (退貨明細)

```sql
CREATE TABLE refund_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    refund_id INT NOT NULL,
    order_item_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(12,2) NOT NULL,
    refund_amount DECIMAL(12,2) NOT NULL,
    return_to_stock BOOLEAN DEFAULT TRUE,

    FOREIGN KEY (refund_id) REFERENCES refunds(id),
    FOREIGN KEY (order_item_id) REFERENCES order_items(id),
    INDEX idx_refund (refund_id)
);
```

### 10.2 促銷相關資料表

#### promotions (促銷活動)

```sql
CREATE TABLE promotions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(30) NOT NULL UNIQUE,
    name NVARCHAR(100) NOT NULL,
    description NVARCHAR(500),
    promotion_type VARCHAR(30) NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME NOT NULL,
    applicable_products JSON,
    applicable_categories JSON,
    excluded_products JSON,
    applicable_stores JSON,
    applicable_member_levels JSON,
    conditions JSON NOT NULL,
    discount_rules JSON NOT NULL,
    usage_limit_per_customer INT,
    total_usage_limit INT,
    current_usage INT DEFAULT 0,
    stackable BOOLEAN DEFAULT FALSE,
    priority INT DEFAULT 0,
    status ENUM('DRAFT', 'ACTIVE', 'INACTIVE', 'EXPIRED') DEFAULT 'DRAFT',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by INT,

    INDEX idx_code (code),
    INDEX idx_status_time (status, start_time, end_time)
);
```

### 10.3 班別相關資料表

#### cashier_shifts (收銀班別)

```sql
CREATE TABLE cashier_shifts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    store_id INT NOT NULL,
    pos_id VARCHAR(20) NOT NULL,
    cashier_id INT NOT NULL,
    shift_date DATE NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME,
    opening_cash DECIMAL(12,2) NOT NULL,
    expected_cash DECIMAL(12,2),
    actual_cash DECIMAL(12,2),
    cash_difference DECIMAL(12,2),
    difference_note TEXT,
    total_sales DECIMAL(12,2) DEFAULT 0,
    total_refunds DECIMAL(12,2) DEFAULT 0,
    total_transactions INT DEFAULT 0,
    status ENUM('OPEN', 'CLOSED') DEFAULT 'OPEN',
    approved_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (store_id) REFERENCES stores(id),
    FOREIGN KEY (cashier_id) REFERENCES users(id),
    INDEX idx_store_date (store_id, shift_date)
);
```

### 10.4 發票相關資料表

#### invoices (發票)

```sql
CREATE TABLE invoices (
    id INT PRIMARY KEY AUTO_INCREMENT,
    invoice_no VARCHAR(12) NOT NULL UNIQUE,
    order_id INT NOT NULL,
    invoice_date DATE NOT NULL,
    invoice_type ENUM('B2C', 'B2C_CARRIER', 'B2C_DONATE', 'B2B') NOT NULL,
    buyer_tax_id VARCHAR(8),
    buyer_name NVARCHAR(100),
    carrier_type VARCHAR(20),
    carrier_no VARCHAR(20),
    donate_code VARCHAR(10),
    sales_amount DECIMAL(12,2) NOT NULL,
    tax_amount DECIMAL(12,2) NOT NULL,
    total_amount DECIMAL(12,2) NOT NULL,
    print_flag BOOLEAN DEFAULT FALSE,
    void_flag BOOLEAN DEFAULT FALSE,
    void_date DATE,
    void_reason NVARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (order_id) REFERENCES orders(id),
    INDEX idx_invoice_no (invoice_no),
    INDEX idx_order (order_id)
);
```

---

## 11. API規格

### 11.1 訂單 API

#### 建立訂單 (POS結帳)

```
POST /api/v1/orders
```

**請求內容**:
```json
{
  "store_id": 1,
  "pos_id": "POS-01",
  "customer_id": 123,
  "items": [
    {
      "product_id": 456,
      "variant_id": null,
      "quantity": 2,
      "unit_price": 299,
      "discount_amount": 0
    },
    {
      "product_id": 789,
      "variant_id": 101,
      "quantity": 1,
      "unit_price": 890,
      "discount_amount": 50
    }
  ],
  "payments": [
    {
      "method": "CASH",
      "amount": 1500,
      "received_amount": 2000,
      "change_amount": 500
    }
  ],
  "points_used": 0,
  "promotion_ids": [10],
  "coupon_code": null,
  "invoice": {
    "type": "B2C_CARRIER",
    "carrier_type": "MOBILE",
    "carrier_no": "/ABC1234"
  },
  "notes": ""
}
```

**回應**:
```json
{
  "success": true,
  "data": {
    "order_id": 10001,
    "order_no": "SO202512310001",
    "subtotal": 1488,
    "discount_amount": 74,
    "tax_amount": 71,
    "total_amount": 1485,
    "points_earned": 148,
    "invoice": {
      "invoice_no": "AB12345678",
      "type": "B2C_CARRIER"
    },
    "created_at": "2025-12-31T14:30:00Z"
  }
}
```

#### 取得訂單列表

```
GET /api/v1/orders
```

**查詢參數**:
| 參數 | 類型 | 說明 |
|------|------|------|
| page | int | 頁碼 |
| per_page | int | 每頁筆數 |
| store_id | int | 門市ID |
| cashier_id | int | 收銀員ID |
| customer_id | int | 會員ID |
| status | string | 狀態篩選 |
| date_from | date | 起始日期 |
| date_to | date | 結束日期 |
| min_amount | number | 最低金額 |
| max_amount | number | 最高金額 |

#### 訂單作廢

```
POST /api/v1/orders/:id/void
```

**請求內容**:
```json
{
  "reason": "客戶取消購買",
  "approver_id": 5
}
```

### 11.2 退貨 API

#### 建立退貨單

```
POST /api/v1/refunds
```

**請求內容**:
```json
{
  "order_id": 10001,
  "refund_type": "REFUND",
  "reason_code": "DEFECT",
  "reason_note": "T-Shirt有汙漬",
  "items": [
    {
      "order_item_id": 20001,
      "quantity": 2,
      "return_to_stock": true
    }
  ],
  "refund_method": "CASH",
  "approver_id": 5
}
```

### 11.3 促銷 API

#### 取得適用促銷

```
POST /api/v1/promotions/applicable
```

**請求內容**:
```json
{
  "store_id": 1,
  "customer_id": 123,
  "items": [
    { "product_id": 456, "quantity": 2, "price": 299 },
    { "product_id": 789, "quantity": 1, "price": 890 }
  ]
}
```

**回應**:
```json
{
  "success": true,
  "data": {
    "applicable_promotions": [
      {
        "id": 10,
        "code": "YEAR_END_SALE",
        "name": "年終特賣",
        "type": "THRESHOLD_PERCENT",
        "discount_amount": 74,
        "description": "滿$1000享95折"
      }
    ],
    "original_total": 1488,
    "discount_total": 74,
    "final_total": 1414
  }
}
```

### 11.4 班別 API

#### 開班

```
POST /api/v1/shifts/open
```

**請求內容**:
```json
{
  "store_id": 1,
  "pos_id": "POS-01",
  "opening_cash": 5000
}
```

#### 交班/日結

```
POST /api/v1/shifts/:id/close
```

**請求內容**:
```json
{
  "actual_cash": 36680,
  "cash_counts": {
    "1000": 30,
    "500": 10,
    "100": 16,
    "50": 3,
    "10": 3,
    "5": 0,
    "1": 0
  },
  "difference_note": "找零誤差"
}
```

---

**文件結束**

[返回主文件](SA_00_主文件.md) | [上一章：基礎資料模組](SA_01_基礎資料模組.md) | [下一章：庫存模組](SA_03_庫存模組.md)
