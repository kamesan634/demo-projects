# 零售業簡易ERP系統 - 採購模組 SA文件

**文件版本**: v1.0
**建立日期**: 2025-12-31
**模組代碼**: M05
**關聯主文件**: [SA_00_主文件.md](SA_00_主文件.md)

---

## 目錄

1. [模組概述](#1-模組概述)
2. [採購單管理](#2-採購單管理)
3. [進貨驗收](#3-進貨驗收)
4. [採購退貨](#4-採購退貨)
5. [採購建議](#5-採購建議)
6. [供應商價格管理](#6-供應商價格管理)
7. [系統流程圖](#7-系統流程圖)
8. [資料表設計](#8-資料表設計)
9. [API規格](#9-api規格)

---

## 1. 模組概述

### 1.1 模組說明

採購模組負責管理商品的採購流程，包括採購單建立、審核、進貨驗收、採購退貨等功能，並與庫存模組整合，自動更新庫存數量與商品成本。

### 1.2 功能清單

| 功能代碼 | 功能名稱 | 優先順序 |
|---------|---------|:-------:|
| F06-001 | 供應商管理 | P0 |
| F06-002 | 採購單管理 | P0 |
| F06-003 | 進貨驗收 | P0 |
| F06-004 | 採購退貨 | P1 |
| F06-005 | 採購建議 | P1 |
| F06-006 | 供應商價格管理 | P2 |

### 1.3 模組關聯

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  商品管理   │────>│   採購模組   │────>│  庫存模組   │
│             │     │             │     │  (入庫)     │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
┌─────────────┐            │
│  供應商管理  │<───────────┤
└─────────────┘            │
                           ▼
                    ┌─────────────┐
                    │  報表模組   │
                    │  (採購報表) │
                    └─────────────┘
```

---

## 2. 採購單管理

### 2.1 採購單管理 (F06-002)

**功能說明**: 建立與管理採購訂單。

#### 採購單狀態

| 狀態代碼 | 狀態名稱 | 說明 | 可執行操作 |
|---------|---------|------|-----------|
| DRAFT | 草稿 | 尚未送出 | 編輯、送審、刪除 |
| PENDING | 待審核 | 等待主管審核 | 核准、退回 |
| APPROVED | 已核准 | 審核通過 | 轉入庫、取消 |
| PARTIAL | 部分到貨 | 部分商品已入庫 | 繼續入庫、關閉 |
| COMPLETED | 已完成 | 全部入庫完成 | - |
| CLOSED | 已關閉 | 手動關閉 | - |
| CANCELLED | 已取消 | 採購取消 | - |

#### 採購單狀態流程

```
                    ┌─────────┐
                    │  DRAFT  │
                    │  草稿   │
                    └────┬────┘
                         │ 送審
                         ▼
                    ┌─────────┐
          ┌─退回───│ PENDING │
          │        │ 待審核  │
          │        └────┬────┘
          │             │ 核准
          ▼             ▼
     ┌─────────┐   ┌─────────┐
     │  DRAFT  │   │APPROVED │───取消───> CANCELLED
     │  草稿   │   │ 已核准  │
     └─────────┘   └────┬────┘
                        │ 入庫
              ┌─────────┴─────────┐
              ▼                   ▼
         ┌─────────┐         ┌─────────┐
         │ PARTIAL │         │COMPLETED│
         │部分到貨 │         │ 已完成  │
         └────┬────┘         └─────────┘
              │ 關閉/全部入庫
              ▼
         ┌─────────┐
         │ CLOSED  │
         │ 已關閉  │
         └─────────┘
```

#### 採購單表頭欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 採購單號 | VARCHAR(30) | Y | 自動產生 |
| 供應商 | INT (FK) | Y | - |
| 採購日期 | DATE | Y | 預設今日 |
| 預計到貨日 | DATE | Y | - |
| 入庫倉庫 | INT (FK) | Y | 預設倉庫 |
| 付款條件 | ENUM | Y | 帶出供應商預設 |
| 幣別 | VARCHAR(3) | Y | 預設TWD |
| 稅別 | ENUM | Y | 應稅/免稅 |
| 採購人員 | INT (FK) | Y | 預設登入者 |
| 備註 | TEXT | N | - |
| 狀態 | ENUM | Y | - |

#### 採購單明細欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 商品 | INT (FK) | Y | - |
| 規格 | INT (FK) | N | 有規格商品 |
| 採購數量 | INT | Y | - |
| 單位 | VARCHAR(10) | Y | - |
| 單價 | DECIMAL(12,2) | Y | 進貨價 |
| 稅額 | DECIMAL(12,2) | Y | 自動計算 |
| 小計 | DECIMAL(12,2) | Y | 自動計算 |
| 已入庫數量 | INT | - | 系統維護 |
| 未入庫數量 | INT | - | 系統計算 |
| 供應商料號 | VARCHAR(50) | N | 供應商商品編號 |
| 備註 | NVARCHAR(200) | N | - |

#### 採購單建立畫面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 採購單維護                                     [儲存] [送審] [取消]    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 採購單號: [PO202512310001] (自動)    狀態: ● 草稿                     │
│                                                                        │
│ 供 應 商: [ABC服飾批發商 ▼]          聯絡人: 王先生  電話: 02-12345678│
│ 採購日期: [2025-12-31]               預計到貨: [2026-01-07]           │
│ 入庫倉庫: [總倉庫 ▼]                 採購人員: [李小明 ▼]             │
│                                                                        │
│ 付款條件: [月結30天 ▼]  稅別: [應稅 ▼]  幣別: [TWD ▼]                │
│                                                                        │
├────────────────────────────────────────────────────────────────────────┤
│ ┌─ 採購商品明細 ──────────────────────────────────────────────────┐   │
│ │ [新增商品] [從建議匯入] [從Excel匯入]                            │   │
│ │                                                                  │   │
│ │ #  商品編號   商品名稱      單位  數量    單價     稅額    小計   │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │ 1  PRD001    白色T-Shirt   件    100    $150    $750   $15,750 │   │
│ │ 2  PRD002    黑色長褲      件     50    $450   $1,125  $23,625 │   │
│ │ 3  PRD003    皮帶          條     30    $200    $300    $6,300 │   │
│ │                                                        [刪除]   │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │                                                                  │   │
│ │ 商品項數: 3 項    合計數量: 180 件                               │   │
│ │ 未稅金額: $43,500    稅額: $2,175    合計金額: $45,675          │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ 備註: [                                                            ]  │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

#### 業務規則

| 規則編號 | 規則說明 |
|---------|---------|
| BR01 | 採購金額超過設定值需主管審核 |
| BR02 | 已核准的採購單不可修改，需作廢重開 |
| BR03 | 有入庫記錄的採購單不可取消 |
| BR04 | 採購單號建立後不可修改 |
| BR05 | 預計到貨日不可早於採購日期 |
| BR06 | 單價預設帶出供應商報價 |

#### 採購單審核

```
┌────────────────────────────────────────────────────────────────────────┐
│ 採購單審核 - PO202512310001                                    [X]    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 供應商: ABC服飾批發商              採購日期: 2025-12-31               │
│ 採購人員: 李小明                   採購金額: $45,675                   │
│                                                                        │
│ ┌─ 採購明細 ──────────────────────────────────────────────────────┐   │
│ │ 商品編號   商品名稱        數量     單價      金額                │   │
│ │ PRD001    白色T-Shirt     100     $150    $15,750               │   │
│ │ PRD002    黑色長褲         50     $450    $23,625               │   │
│ │ PRD003    皮帶             30     $200     $6,300               │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ 審核意見: [                                                        ]  │
│                                                                        │
│                        [退回]              [核准]                      │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 進貨驗收

### 3.1 進貨驗收 (F06-003)

**功能說明**: 依據採購單執行進貨驗收入庫作業。

#### 驗收流程

```
[開始]
   │
   ▼
┌──────────────────┐
│ 1. 選擇採購單    │
│ • 輸入採購單號   │
│ • 選擇待驗收單   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. 核對送貨單    │
│ • 對照採購單     │
│ • 檢查供應商資訊 │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. 逐項驗收      │
│ • 輸入到貨數量   │
│ • 檢查商品品質   │
│ • 記錄異常狀況   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. 驗收結果判定  │
└────────┬─────────┘
         │
    ┌────┴────┬────────────┬────────────┐
    ▼         ▼            ▼            ▼
[全數驗收] [部分驗收]  [超量到貨]    [驗退]
    │         │            │            │
    ▼         ▼            ▼            ▼
┌────────┐ ┌────────┐ ┌────────┐  ┌────────┐
│全數入庫│ │部分入庫│ │確認處理│  │退回供應│
│        │ │記錄短收│ │接受/拒│  │商       │
└────┬───┘ └────┬───┘ └────┬───┘  └────┬───┘
     │          │          │           │
     └──────────┴──────────┴───────────┘
                    │
                    ▼
┌──────────────────────────┐
│ 5. 確認驗收               │
│ • 產生入庫單             │
│ • 更新庫存數量           │
│ • 更新商品成本           │
│ • 更新採購單狀態         │
└────────────────────────────┘
         │
         ▼
[結束]
```

#### 驗收結果類型

| 結果 | 說明 | 處理方式 |
|------|------|---------|
| 全數驗收 | 到貨數量 = 採購數量 | 正常入庫 |
| 部分驗收 | 到貨數量 < 採購數量 | 入庫到貨部分，記錄短收 |
| 超量到貨 | 到貨數量 > 採購數量 | 需確認是否接受超量 |
| 驗退 | 品質不合格 | 退回供應商 |
| 混合情況 | 部分商品有異常 | 逐項處理 |

#### 驗收單欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 驗收單號 | VARCHAR(30) | Y | 自動產生 |
| 採購單號 | VARCHAR(30) | Y | 關聯採購單 |
| 驗收日期 | DATE | Y | 預設今日 |
| 入庫倉庫 | INT (FK) | Y | 預設採購單倉庫 |
| 送貨單號 | VARCHAR(50) | N | 供應商送貨單 |
| 驗收人員 | INT (FK) | Y | - |

#### 驗收明細欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 商品 | INT (FK) | Y | - |
| 採購數量 | INT | Y | 從採購單帶入 |
| 已入庫數量 | INT | Y | 之前已入庫 |
| 待驗收數量 | INT | Y | 系統計算 |
| 本次到貨數量 | INT | Y | 實際到貨 |
| 本次入庫數量 | INT | Y | 驗收合格數量 |
| 驗退數量 | INT | N | 不合格退回 |
| 驗退原因 | ENUM | N | - |
| 備註 | NVARCHAR(200) | N | - |

#### 驗收作業畫面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 進貨驗收                                          [完成驗收] [取消]    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 採購單號: [PO202512310001  ] [查詢]    供應商: ABC服飾批發商          │
│ 驗收日期: [2025-12-31]                 入庫倉庫: [總倉庫 ▼]           │
│ 送貨單號: [DL20251231-001      ]       驗收人員: [王小明 ▼]           │
│                                                                        │
├────────────────────────────────────────────────────────────────────────┤
│ ┌─ 驗收明細 ──────────────────────────────────────────────────────┐   │
│ │                                                                  │   │
│ │ 商品編號   商品名稱      採購  已入庫  待驗收  到貨  入庫  驗退  │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │ PRD001    白色T-Shirt   100     0      100   [ 100 ][ 100 ][  0]│   │
│ │           狀態: ✓ 正常                                          │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │ PRD002    黑色長褲       50     0       50   [  48 ][  48 ][  2]│   │
│ │           狀態: ⚠ 部分驗退  原因: [商品瑕疵 ▼]                  │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │ PRD003    皮帶           30     0       30   [  30 ][  30 ][  0]│   │
│ │           狀態: ✓ 正常                                          │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │                                                                  │   │
│ │ 合計: 採購 180 件 / 入庫 178 件 / 驗退 2 件                     │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ 備註: [有2件黑色長褲有瑕疵，已退回供應商                          ]   │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

#### 業務規則

| 規則編號 | 規則說明 |
|---------|---------|
| BR01 | 入庫數量不可超過待驗收數量 (除非確認接受超量) |
| BR02 | 驗退需填寫原因 |
| BR03 | 驗收完成後自動產生入庫單 |
| BR04 | 更新採購單狀態 (部分到貨/已完成) |
| BR05 | 入庫後更新商品移動平均成本 |

---

## 4. 採購退貨

### 4.1 採購退貨 (F06-004)

**功能說明**: 處理向供應商退貨的作業。

#### 退貨原因

| 原因碼 | 說明 |
|--------|------|
| DEFECT | 商品瑕疵 |
| DAMAGE | 運送損壞 |
| WRONG | 送錯商品 |
| EXPIRE | 過期商品 |
| EXCESS | 數量過多 |
| QUALITY | 品質不符 |
| OTHER | 其他原因 |

#### 退貨單狀態

| 狀態代碼 | 狀態名稱 | 說明 |
|---------|---------|------|
| DRAFT | 草稿 | 建立中 |
| PENDING | 待審核 | 等待審核 |
| APPROVED | 已核准 | 審核通過 |
| SHIPPED | 已出庫 | 商品已退出 |
| CONFIRMED | 供應商確認 | 供應商已收貨 |
| COMPLETED | 已完成 | 處理完畢 |
| CANCELLED | 已取消 | - |

#### 退貨單欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 退貨單號 | VARCHAR(30) | Y | 自動產生 |
| 原採購單號 | VARCHAR(30) | N | 關聯原採購單 |
| 原入庫單號 | VARCHAR(30) | N | 關聯原入庫單 |
| 供應商 | INT (FK) | Y | - |
| 退貨日期 | DATE | Y | - |
| 出庫倉庫 | INT (FK) | Y | - |
| 退貨原因 | ENUM | Y | - |
| 處理方式 | ENUM | Y | 折讓/換貨/退款 |
| 退貨金額 | DECIMAL(12,2) | Y | - |
| 狀態 | ENUM | Y | - |

#### 退貨流程

```
[開始]
   │
   ▼
┌──────────────────┐
│ 1. 建立退貨單    │
│ • 選擇供應商     │
│ • 關聯原單據     │
│ • 選擇退貨商品   │
│ • 輸入退貨數量   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. 選擇退貨原因  │
│ • 選擇原因類型   │
│ • 填寫詳細說明   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. 選擇處理方式  │
│ • 折讓沖帳       │
│ • 換貨           │
│ • 退款           │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ 4. 需要審核?     │──是─>│ 送交主管審核     │
└────────┬─────────┘     └────────┬─────────┘
         │否                      │
         │<───────────────────────┘
         ▼
┌──────────────────┐
│ 5. 安排退貨出庫  │
│ • 確認出庫       │
│ • 產生出庫單     │
│ • 扣減庫存       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 6. 供應商確認    │
│ • 等待供應商收貨 │
│ • 確認收貨數量   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 7. 處理折讓/退款 │
│ • 沖銷應付帳款   │
│ • 或收到退款     │
└────────┬─────────┘
         │
         ▼
[結束]
```

#### 退貨作業畫面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 採購退貨                                          [儲存] [送審]        │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 退貨單號: [PR202512310001] (自動)    狀態: ● 草稿                     │
│                                                                        │
│ 供 應 商: [ABC服飾批發商 ▼]                                           │
│ 原採購單: [PO202512310001  ] [查詢]  原入庫單: [GR202512310001]       │
│ 退貨日期: [2025-12-31]               出庫倉庫: [總倉庫 ▼]             │
│                                                                        │
│ 退貨原因: [商品瑕疵 ▼]                                                │
│ 處理方式: ● 折讓  ○ 換貨  ○ 退款                                      │
│                                                                        │
├────────────────────────────────────────────────────────────────────────┤
│ ┌─ 退貨商品明細 ──────────────────────────────────────────────────┐   │
│ │ [新增商品]                                                       │   │
│ │                                                                  │   │
│ │ #  商品編號   商品名稱        入庫數量  退貨數量   單價    金額  │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │ 1  PRD002    黑色長褲           48    [   2   ]   $450    $900  │   │
│ │                                                                  │   │
│ │ ─────────────────────────────────────────────────────────────── │   │
│ │ 退貨項數: 1 項    退貨數量: 2 件    退貨金額: $900              │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ 原因說明: [入庫時發現有2件黑色長褲有瑕疵，與供應商確認後退貨    ]    │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 採購建議

### 5.1 採購建議 (F06-005)

**功能說明**: 依據庫存狀況自動產生採購建議。

#### 建議計算邏輯

```
建議採購量 = 安全庫存 + 預估銷售量 - 現有庫存 - 在途庫存

其中:
- 安全庫存: 商品主檔設定
- 預估銷售量: 依歷史銷售計算 (可設定參考天數)
- 現有庫存: 目前庫存數量
- 在途庫存: 已採購未入庫數量
```

#### 建議計算範例

```
商品: 白色T-Shirt
──────────────────────────────────
安全庫存:           50 件
預估銷售量 (7天):   35 件  (日均5件 × 7天)
現有庫存:           32 件
在途庫存:            0 件
──────────────────────────────────
建議採購量: 50 + 35 - 32 - 0 = 53 件
建議採購量 (取整): 60 件 (依MOQ或包裝單位調整)
```

#### 產生方式

| 方式 | 說明 | 使用場景 |
|------|------|---------|
| 依商品 | 指定商品產生建議 | 單一商品補貨 |
| 依分類 | 指定分類產生建議 | 品類採購 |
| 依供應商 | 產生特定供應商商品建議 | 供應商訂貨 |
| 低於安全庫存 | 所有低於安全庫存商品 | 定期補貨 |
| 依倉庫 | 指定倉庫的商品 | 門市補貨 |

#### 建議清單欄位

| 欄位 | 說明 |
|------|------|
| 商品編號 | - |
| 商品名稱 | - |
| 供應商 | 主要供應商 |
| 現有庫存 | 各倉庫合計 |
| 安全庫存 | - |
| 缺口 | 安全庫存 - 現有庫存 |
| 在途庫存 | 已採購未入庫 |
| 預估銷售 | N天預估銷售量 |
| 建議數量 | 計算結果 |
| 單價 | 供應商報價 |
| 建議金額 | 建議數量 × 單價 |
| 選取 | 勾選轉採購單 |

#### 採購建議畫面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 採購建議                              [產生建議] [轉採購單] [匯出]     │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 計算方式: [低於安全庫存 ▼]  供應商: [全部 ▼]  分類: [全部 ▼]         │
│ 預估天數: [7] 天           倉庫: [全部 ▼]                             │
│                                                                        │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ ☑ 全選                                      共 15 項  金額 $125,400   │
│                                                                        │
│ ☑  商品編號  商品名稱      供應商    庫存  安全  缺口 在途 建議  金額 │
│ ──────────────────────────────────────────────────────────────────    │
│ ☑  PRD001   白色T-Shirt  ABC批發     32    50   -18    0   60  $9,000│
│ ☑  PRD002   黑色長褲     ABC批發     15    30   -15   20   30 $13,500│
│ ☑  PRD008   休閒鞋       DEF貿易     45    50    -5    0   30 $24,000│
│ ☐  PRD010   棒球帽       GHI商行     22    30    -8   10    0     $0 │
│    (在途庫存已足夠)                                                    │
│ ☑  PRD015   皮夾         ABC批發      5    30   -25    0   30 $24,000│
│                                                                        │
│ ──────────────────────────────────────────────────────────────────    │
│ 已選擇: 4 項  建議採購金額: $70,500                                    │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

#### 轉採購單功能

| 功能 | 說明 |
|------|------|
| 單一供應商 | 選取同供應商商品，建立一張採購單 |
| 多供應商 | 自動依供應商分組，建立多張採購單 |
| 手動調整 | 轉單前可調整數量 |
| 合併採購單 | 加入現有草稿採購單 |

---

## 6. 供應商價格管理

### 6.1 供應商價格管理 (F06-006)

**功能說明**: 管理各供應商的商品報價與價格歷史。

#### 價格設定欄位

| 欄位名稱 | 資料型態 | 必填 | 說明 |
|---------|---------|:----:|------|
| 供應商 | INT (FK) | Y | - |
| 商品 | INT (FK) | Y | - |
| 供應商料號 | VARCHAR(50) | N | 供應商商品編號 |
| 進貨價格 | DECIMAL(12,2) | Y | - |
| 幣別 | VARCHAR(3) | Y | - |
| 最低訂購量 | INT | N | MOQ |
| 包裝單位 | INT | N | 包裝規格 |
| 前置天數 | INT | N | 交貨期 |
| 生效日期 | DATE | Y | - |
| 失效日期 | DATE | N | - |
| 備註 | NVARCHAR(200) | N | - |

#### 價格維護畫面

```
┌────────────────────────────────────────────────────────────────────────┐
│ 供應商價格管理                                    [新增] [匯入] [匯出] │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 供應商: [ABC服飾批發商 ▼]                                             │
│                                                                        │
│ 搜尋商品: [                    ] [🔍]                                 │
│                                                                        │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 商品編號   商品名稱        供應商料號   單價   MOQ  前置期  生效日    │
│ ──────────────────────────────────────────────────────────────────    │
│ PRD001    白色T-Shirt    ABC-TS001    $150    10   7天   2025-01-01  │
│                                                           [編輯]      │
│ PRD002    黑色長褲       ABC-PT001    $450    10   7天   2025-01-01  │
│                                                           [編輯]      │
│ PRD003    皮帶           ABC-BT001    $200    20   7天   2025-01-01  │
│                                                           [編輯]      │
│ PRD015    皮夾           ABC-WL001    $800    10  14天   2025-01-01  │
│                                                           [編輯]      │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

#### 價格異動歷史

| 欄位 | 說明 |
|------|------|
| 異動日期 | 價格變動日期 |
| 原價格 | 變動前價格 |
| 新價格 | 變動後價格 |
| 漲跌幅 | 價格變動百分比 |
| 異動原因 | - |
| 異動人員 | - |

#### 多供應商比價

```
┌────────────────────────────────────────────────────────────────────────┐
│ 供應商比價 - PRD001 白色T-Shirt                                [X]    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ 供應商           單價    MOQ   前置期   最後採購日   建議              │
│ ──────────────────────────────────────────────────────────────────    │
│ ABC服飾批發商   $150     10     7天    2025-12-15   ⭐ 推薦 (價低)    │
│ DEF服飾商行     $155      5     5天    2025-11-20                      │
│ GHI貿易公司     $160     20    10天    2025-10-01                      │
│                                                                        │
│ 目前成本: $150   最低報價: $150 (ABC服飾批發商)                       │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 系統流程圖

### 7.1 採購進貨完整流程

```
[開始]
   │
   ▼
┌──────────────────┐     ┌──────────────────┐
│ 庫存低於         │──是─>│ 產生採購         │
│ 安全庫存?        │     │ 建議清單         │
└──────────────────┘     └────────┬─────────┘
   │否                            │
   ▼                              ▼
┌──────────────────┐     ┌──────────────────┐
│ 手動建立         │     │ 依建議建立       │
│ 採購單           │<────│ 採購單           │
└────────┬─────────┘     └──────────────────┘
         │
         ▼
┌──────────────────┐
│ 選擇供應商       │
│ 輸入商品明細     │
│ 設定到貨日       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ 需要審核?        │──是─>│ 送交主管審核     │
└────────┬─────────┘     └────────┬─────────┘
         │否                      │
         │              ┌─────────┴─────────┐
         │              ▼                   ▼
         │          [核准]              [退回]
         │              │                   │
         │              │                   ▼
         │              │         ┌──────────────────┐
         │              │         │ 修改採購單       │
         │              │         └────────┬─────────┘
         │<─────────────┴──────────────────┘
         ▼
┌──────────────────┐
│ 發送給供應商     │
│ (可選)           │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 等待到貨         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 供應商送貨       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 驗收作業         │
│ • 核對數量       │
│ • 檢查品質       │
└────────┬─────────┘
         │
    ┌────┴─────┬────────────┬────────────┐
    ▼          ▼            ▼            ▼
[全數合格] [部分合格]   [超量到貨]  [全數不合格]
    │          │            │            │
    ▼          ▼            ▼            ▼
┌────────┐ ┌────────┐  ┌────────┐   ┌────────┐
│全數入庫│ │部分入庫│  │確認處理│   │退回供應│
│        │ │異常處理│  │        │   │商       │
└────┬───┘ └────┬───┘  └────┬───┘   └────┬───┘
     │          │           │            │
     └──────────┴───────────┘            │
                │                        │
                ▼                        │
┌──────────────────────┐                │
│ • 產生入庫單         │                │
│ • 更新庫存           │                │
│ • 更新商品成本       │                │
│ • 更新採購單狀態     │                │
└──────────────────────┘                │
                │                        │
                ▼<───────────────────────┘
[結束]
```

---

## 8. 資料表設計

### 8.1 採購相關資料表

#### purchase_orders (採購單)

```sql
CREATE TABLE purchase_orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    po_no VARCHAR(30) NOT NULL UNIQUE,
    supplier_id INT NOT NULL,
    order_date DATE NOT NULL,
    expected_date DATE NOT NULL,
    warehouse_id INT NOT NULL,
    payment_terms ENUM('CASH', 'COD', 'NET30', 'NET60', 'NET90') NOT NULL,
    currency VARCHAR(3) DEFAULT 'TWD',
    tax_type ENUM('TAX', 'TAX_FREE') DEFAULT 'TAX',
    buyer_id INT NOT NULL,

    -- 金額
    subtotal DECIMAL(14,2) DEFAULT 0,
    tax_amount DECIMAL(14,2) DEFAULT 0,
    total_amount DECIMAL(14,2) DEFAULT 0,

    -- 狀態
    status ENUM('DRAFT', 'PENDING', 'APPROVED', 'PARTIAL', 'COMPLETED', 'CLOSED', 'CANCELLED') DEFAULT 'DRAFT',

    -- 審核
    approved_by INT,
    approved_at DATETIME,
    approval_notes TEXT,

    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    FOREIGN KEY (buyer_id) REFERENCES users(id),
    INDEX idx_po_no (po_no),
    INDEX idx_supplier (supplier_id),
    INDEX idx_status (status),
    INDEX idx_order_date (order_date)
);
```

#### purchase_order_items (採購單明細)

```sql
CREATE TABLE purchase_order_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    po_id INT NOT NULL,
    product_id INT NOT NULL,
    variant_id INT,
    quantity INT NOT NULL,
    unit VARCHAR(10) NOT NULL,
    unit_price DECIMAL(12,2) NOT NULL,
    tax_amount DECIMAL(12,2) DEFAULT 0,
    subtotal DECIMAL(12,2) NOT NULL,
    received_quantity INT DEFAULT 0,
    pending_quantity INT GENERATED ALWAYS AS (quantity - received_quantity) STORED,
    supplier_sku VARCHAR(50),
    notes NVARCHAR(200),

    FOREIGN KEY (po_id) REFERENCES purchase_orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_po (po_id)
);
```

#### purchase_receipts (採購驗收單)

```sql
CREATE TABLE purchase_receipts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    receipt_no VARCHAR(30) NOT NULL UNIQUE,
    po_id INT NOT NULL,
    receipt_date DATE NOT NULL,
    warehouse_id INT NOT NULL,
    delivery_no VARCHAR(50),
    receiver_id INT NOT NULL,
    total_quantity INT DEFAULT 0,
    received_quantity INT DEFAULT 0,
    rejected_quantity INT DEFAULT 0,
    status ENUM('DRAFT', 'COMPLETED') DEFAULT 'DRAFT',
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (po_id) REFERENCES purchase_orders(id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    INDEX idx_receipt_no (receipt_no),
    INDEX idx_po (po_id)
);
```

#### purchase_receipt_items (驗收單明細)

```sql
CREATE TABLE purchase_receipt_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    receipt_id INT NOT NULL,
    po_item_id INT NOT NULL,
    product_id INT NOT NULL,
    ordered_quantity INT NOT NULL,
    previously_received INT NOT NULL,
    pending_quantity INT NOT NULL,
    arrived_quantity INT NOT NULL,
    received_quantity INT NOT NULL,
    rejected_quantity INT DEFAULT 0,
    rejection_reason ENUM('DEFECT', 'DAMAGE', 'WRONG', 'EXPIRE', 'QUALITY', 'OTHER'),
    notes NVARCHAR(200),

    FOREIGN KEY (receipt_id) REFERENCES purchase_receipts(id),
    FOREIGN KEY (po_item_id) REFERENCES purchase_order_items(id),
    INDEX idx_receipt (receipt_id)
);
```

#### purchase_returns (採購退貨單)

```sql
CREATE TABLE purchase_returns (
    id INT PRIMARY KEY AUTO_INCREMENT,
    return_no VARCHAR(30) NOT NULL UNIQUE,
    supplier_id INT NOT NULL,
    original_po_no VARCHAR(30),
    original_receipt_no VARCHAR(30),
    return_date DATE NOT NULL,
    warehouse_id INT NOT NULL,
    return_reason ENUM('DEFECT', 'DAMAGE', 'WRONG', 'EXPIRE', 'EXCESS', 'QUALITY', 'OTHER') NOT NULL,
    handling_method ENUM('CREDIT', 'EXCHANGE', 'REFUND') NOT NULL,
    total_quantity INT DEFAULT 0,
    total_amount DECIMAL(14,2) DEFAULT 0,
    reason_notes TEXT,
    status ENUM('DRAFT', 'PENDING', 'APPROVED', 'SHIPPED', 'CONFIRMED', 'COMPLETED', 'CANCELLED') DEFAULT 'DRAFT',
    requested_by INT,
    approved_by INT,
    approved_at DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(id),
    INDEX idx_return_no (return_no),
    INDEX idx_supplier (supplier_id)
);
```

#### purchase_return_items (退貨單明細)

```sql
CREATE TABLE purchase_return_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    return_id INT NOT NULL,
    product_id INT NOT NULL,
    variant_id INT,
    quantity INT NOT NULL,
    unit_price DECIMAL(12,2) NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    notes NVARCHAR(200),

    FOREIGN KEY (return_id) REFERENCES purchase_returns(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_return (return_id)
);
```

#### supplier_prices (供應商價格)

```sql
CREATE TABLE supplier_prices (
    id INT PRIMARY KEY AUTO_INCREMENT,
    supplier_id INT NOT NULL,
    product_id INT NOT NULL,
    variant_id INT,
    supplier_sku VARCHAR(50),
    unit_price DECIMAL(12,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'TWD',
    min_order_quantity INT,
    pack_size INT,
    lead_time_days INT,
    effective_date DATE NOT NULL,
    expiry_date DATE,
    is_primary BOOLEAN DEFAULT FALSE,
    notes NVARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    UNIQUE KEY uk_supplier_product (supplier_id, product_id, variant_id, effective_date),
    INDEX idx_supplier (supplier_id),
    INDEX idx_product (product_id)
);
```

#### supplier_price_history (價格異動歷史)

```sql
CREATE TABLE supplier_price_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    supplier_price_id INT NOT NULL,
    old_price DECIMAL(12,2) NOT NULL,
    new_price DECIMAL(12,2) NOT NULL,
    change_percent DECIMAL(5,2),
    change_reason NVARCHAR(200),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    changed_by INT,

    FOREIGN KEY (supplier_price_id) REFERENCES supplier_prices(id),
    INDEX idx_supplier_price (supplier_price_id)
);
```

---

## 9. API規格

### 9.1 採購單 API

#### 取得採購單列表

```
GET /api/v1/purchase-orders
```

**查詢參數**:

| 參數 | 類型 | 說明 |
|------|------|------|
| page | int | 頁碼 |
| per_page | int | 每頁筆數 |
| supplier_id | int | 供應商ID |
| status | string | 狀態篩選 |
| date_from | date | 起始日期 |
| date_to | date | 結束日期 |
| keyword | string | 採購單號/供應商名稱 |

**回應範例**:

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "po_no": "PO202512310001",
      "supplier": {
        "id": 10,
        "name": "ABC服飾批發商"
      },
      "order_date": "2025-12-31",
      "expected_date": "2026-01-07",
      "warehouse": {
        "id": 1,
        "name": "總倉庫"
      },
      "total_amount": 45675,
      "status": "APPROVED",
      "item_count": 3,
      "received_percentage": 0
    }
  ],
  "meta": {
    "page": 1,
    "per_page": 20,
    "total": 45
  }
}
```

#### 建立採購單

```
POST /api/v1/purchase-orders
```

**請求內容**:

```json
{
  "supplier_id": 10,
  "order_date": "2025-12-31",
  "expected_date": "2026-01-07",
  "warehouse_id": 1,
  "payment_terms": "NET30",
  "tax_type": "TAX",
  "items": [
    {
      "product_id": 456,
      "quantity": 100,
      "unit": "件",
      "unit_price": 150
    },
    {
      "product_id": 789,
      "quantity": 50,
      "unit": "件",
      "unit_price": 450
    }
  ],
  "notes": ""
}
```

#### 送審採購單

```
POST /api/v1/purchase-orders/:id/submit
```

#### 核准採購單

```
POST /api/v1/purchase-orders/:id/approve
```

**請求內容**:

```json
{
  "approval_notes": "核准"
}
```

#### 退回採購單

```
POST /api/v1/purchase-orders/:id/reject
```

**請求內容**:

```json
{
  "approval_notes": "單價過高，請重新議價"
}
```

### 9.2 驗收 API

#### 建立驗收單

```
POST /api/v1/purchase-receipts
```

**請求內容**:

```json
{
  "po_id": 1,
  "receipt_date": "2025-12-31",
  "warehouse_id": 1,
  "delivery_no": "DL20251231-001",
  "items": [
    {
      "po_item_id": 1,
      "arrived_quantity": 100,
      "received_quantity": 100,
      "rejected_quantity": 0
    },
    {
      "po_item_id": 2,
      "arrived_quantity": 48,
      "received_quantity": 48,
      "rejected_quantity": 2,
      "rejection_reason": "DEFECT",
      "notes": "有瑕疵"
    }
  ],
  "notes": ""
}
```

### 9.3 採購建議 API

#### 產生採購建議

```
POST /api/v1/purchase-suggestions/generate
```

**請求內容**:

```json
{
  "method": "LOW_STOCK",
  "supplier_id": null,
  "category_id": null,
  "warehouse_id": null,
  "forecast_days": 7
}
```

**回應範例**:

```json
{
  "success": true,
  "data": {
    "generated_at": "2025-12-31T10:00:00Z",
    "items": [
      {
        "product_id": 456,
        "product_name": "白色T-Shirt",
        "supplier_id": 10,
        "supplier_name": "ABC服飾批發商",
        "current_stock": 32,
        "safety_stock": 50,
        "shortage": 18,
        "in_transit": 0,
        "forecast_sales": 35,
        "suggested_quantity": 60,
        "unit_price": 150,
        "suggested_amount": 9000
      }
    ],
    "summary": {
      "total_items": 15,
      "total_amount": 125400
    }
  }
}
```

#### 轉採購單

```
POST /api/v1/purchase-suggestions/convert
```

**請求內容**:

```json
{
  "items": [
    {
      "product_id": 456,
      "supplier_id": 10,
      "quantity": 60
    },
    {
      "product_id": 789,
      "supplier_id": 10,
      "quantity": 30
    }
  ],
  "expected_date": "2026-01-07",
  "warehouse_id": 1
}
```

### 9.4 供應商價格 API

#### 取得供應商商品價格

```
GET /api/v1/suppliers/:id/prices
```

#### 更新供應商價格

```
PUT /api/v1/supplier-prices/:id
```

**請求內容**:

```json
{
  "unit_price": 155,
  "min_order_quantity": 10,
  "lead_time_days": 7,
  "effective_date": "2026-01-01",
  "change_reason": "供應商調價"
}
```

#### 商品供應商比價

```
GET /api/v1/products/:id/supplier-prices
```

**回應範例**:

```json
{
  "success": true,
  "data": {
    "product": {
      "id": 456,
      "name": "白色T-Shirt",
      "current_cost": 150
    },
    "suppliers": [
      {
        "supplier_id": 10,
        "supplier_name": "ABC服飾批發商",
        "unit_price": 150,
        "currency": "TWD",
        "min_order_quantity": 10,
        "lead_time_days": 7,
        "is_primary": true,
        "last_purchase_date": "2025-12-15"
      },
      {
        "supplier_id": 11,
        "supplier_name": "DEF服飾商行",
        "unit_price": 155,
        "currency": "TWD",
        "min_order_quantity": 5,
        "lead_time_days": 5,
        "is_primary": false,
        "last_purchase_date": "2025-11-20"
      }
    ],
    "lowest_price": {
      "supplier_id": 10,
      "supplier_name": "ABC服飾批發商",
      "unit_price": 150
    }
  }
}
```

---

**文件結束**

[返回主文件](SA_00_主文件.md) | [上一章：庫存模組](SA_03_庫存模組.md) | [下一章：報表模組](SA_05_報表模組.md)
